
#################################################################################
# General purpose Asyn motor template.
# Required macros: P, M, PORT, ADDR, DESC, VELO, MRES, PREC, EGU, DHLM, DLLM, TWV

record(motor,"$(P)$(M)")
{
	field(DESC,"$(DESC)")
	field(DTYP,"$(DTYP=asynMotor)")
	field(DIR,"$(DIR=0)")
	field(VELO,"$(VELO)")
	field(VBAS,"$(VBAS=0)")
	field(ACCL,"$(ACCL=0.5)")
	field(BDST,"$(BDST=0)")
	field(BVEL,"$(BVEL=0)")
	field(BACC,"$(BACC=0.5)")
	field(OUT,"@asyn($(PORT),$(ADDR))")
	field(MRES,"$(MRES)")
	field(PREC,"$(PREC)")
	field(EGU,"$(EGU)")
	field(DHLM,"$(DHLM)")
	field(DLLM,"$(DLLM)")
	field(INIT,"$(INIT=)")
	field(RTRY,"$(RTRY=0)")
        field(DLY,"$(DLY=0)")   
        field(HVEL,"$(HVEL=$(VELO))")
        field(SREV, "$(SREV=1000)")
        field(RRES, "$(RRES=)")
        field(TWV, "$(TWV)")
        field(ERES, "$(ERES=)")
        field(JAR, "$(JAR=)")
        field(UEIP, "$(UEIP=0)")
        field(URIP, "$(URIP=0)")        
        field(RDBL, "$(RDBL=)")         
        field(VMAX, "$(VMAX=$(VELO))")
        field(OFF, "$(OFF=0)")
        field(RDBD, "$(RDBD=)")
        field(FOFF, "$(FOFF=0)")
        field(ADEL, "$(ADEL=0)")
	field(MDEL, "$(MDEL=0)")
        field(NTM, "$(NTM=1)")
        field(HLSV, "$(HLSV=MAJOR)")
        field(SDIS, "$(P)$(M):SDIS.VAL") 
        info(autosaveFields_pass0, "DVAL OFF")
	info(autosaveFields, "DIR DHLM DLLM TWV VBAS VELO ACCL BDST BVEL BACC RDBD EGU RTRY UEIP URIP DLY PREC DISA DISP FOFF OFF FRAC OMSL JVEL JAR ADEL MDEL HVEL")
	info(archive, "Monitor, 00:00:01, VAL OFF RBV DMOV MISS MSTA STAT LVIO HLS LLS")
}

#Enable/Disable channel access for the motor record
record(bo, "$(P)$(M):Disable") {
  field(VAL, "0")
  field(PINI, "YES")
  field(ZNAM, "Enabled")
  field(ONAM, "Disabled")
  info(autosaveFields_pass0, "VAL")
  field(OUT, "$(P)$(M):SDIS.A PP")
}

#Record that will disable and re-enable record if any of its inputs are non-zero
record(calcout, "$(P)$(M):SDIS") {
  field(DESC, "Disable on non-zero input")
  field(VAL, "0")
  field(CALC, "(A|B|C|D|E|F|G|H|I|J|K|L)>0")
  field(OUT, "$(P)$(M).DISP PP")
}

#Record to provide RMP scaling to engineering units
#Depending on UEIP we may not have this on RBV
record(calc, "$(P)$(M):MotorPos")
{
        field(DESC,"Motor Position")
        field(INPA,"$(P)$(M).RMP CP")
	field(INPB,"$(P)$(M).MRES NPP")
	field(CALC,"(A*B)")
	field(PREC,"$(PREC)")
	field(EGU, "$(EGU)")
	info(archive, "Monitor, 00:00:01, VAL")
}

#Record to provide REP scaling to engineering units
#Depending on UEIP we may not have this on RBV
record(calc, "$(P)$(M):EncoderPos")
{
        field(DESC,"Encoder Position")
        field(INPA,"$(P)$(M).REP CP")
	field(INPB,"$(P)$(M).ERES NPP")
	field(CALC,"(A*B)")
	field(PREC,"$(PREC)")
	field(EGU, "$(EGU)")
	info(archive, "Monitor, 00:00:01, VAL")	
}

#Record to calculate the following error
record(calc, "$(P)$(M):FERROR")
{
        field(DESC,"Following Error")
        field(INPA,"$(P)$(M).RMP CP")
        field(INPB,"$(P)$(M).REP NPP")
        field(INPC,"$(P)$(M).MRES NPP")
        field(INPD,"$(P)$(M).ERES NPP")
        field(CALC,"ABS((A*C)-(B*D))")
        field(FLNK,"$(P)$(M):FERRORMAX")
        field(PREC,"$(PREC)")
        field(EGU, "$(EGU)")
}


#Record to store the maximum following error
record(calc, "$(P)$(M):FERRORMAX")
{
        field(DESC,"Following Error Max")
        field(INPA,"$(P)$(M):FERROR.VAL")
        field(INPB,"$(P)$(M):FERRORMAX.VAL")
        field(CALC,"(A>B)?A:B")
        field(HIGH,"$(FEHIGH=0)")
        field(HIHI,"$(FEHIHI=0)")
        field(HHSV,"$(FEHHSV=NO_ALARM)")
        field(HSV, "$(FEHSV=NO_ALARM)")
        field(PREC,"$(PREC)")
        field(EGU, "$(EGU)")
	info(autosaveFields, "VAL")
	info(archive, "Monitor, 00:00:10")
}       

#Record to reset the maximum following error
record(bo, "$(P)$(M):FEMAXRESET")
{
        field(DESC,"Reset max following error")
        field(DTYP,"Soft Channel")
        field(OUT, "$(P)$(M):FERRORMAX.VAL")
        field(VAL, "0")
}

#Include record to provide calculated error
include "error_calc.db"

#Include records to control the visibility of the home buttons on motor_detail.db
include "home_visibility.db"
