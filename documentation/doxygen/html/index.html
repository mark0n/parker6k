<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>parker6k: Parker 6K Controller Epics Driver.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li class="current"><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>Parker 6K Controller Epics Driver.</h1><h3>1-0 </h3><h2><a class="anchor" id="user">
User Guide</a></h2>
<h3><a class="anchor" id="intro">
Introduction</a></h3>
<p>The parker6k driver enables control of a Parker 6K controller via the EPICS motor record.</p>
<p>This is the Asyn 'model3' version which has a number of advantages over the model 1 driver:</p>
<ul>
<li>
Detect motion outside of a normal move command </li>
<li>
Reflect error conditions in the motor record alarm fields </li>
<li>
Control and read controller-wide information </li>
<li>
Additonal axis specific capabilities outside of the motor record </li>
<li>
Easy debugging (asyn record, low level commands via waveform PVs, custom logging). </li>
<li>
Adjustable polling rates </li>
<li>
Ability to set both motor and encoder position </li>
</ul>
<h4><a class="anchor" id="notes">
Notes</a></h4>
<p>The driver has been tested on stepper drives (with and without encoders) using a 4-axis compumotor controller. The driver has not been tested with servo drives.</p>
<p>The move function automatically sets up the S-curve parameters at the start of the move (similar to model 1 driver). It uses half the acceleration rate for the jerk parameters (AA, ADA).</p>
<p>The home function uses the home velocity before executing the home (HOM). It is expected that the controller home parameters have already been configured (eg. HOMZ). NOTE: for encoder based systems the controller does not reset the encoder position on a successful home. Currently the user must do this after a home.</p>
<p>In order to set the position on an axis: </p>
<ol>
<li>
set SET field to 1 </li>
<li>
set DVAL to desired position </li>
<li>
set OFF back to what it was </li>
<li>
set SET back to 0 </li>
</ol>
<p>By setting the position to zero, the user can perform a manual home on a limit switch for example (which the controller does not support).</p>
<p>It may be necessary to set ERES again before setting the position (or toggle UEIP).</p>
<h3><a class="anchor" id="startup">
IOC Startup File</a></h3>
<p>There is an example IOC in parker6k/example that demonstrates how to use the driver. There are several IOC startup file commands required:</p>
<p><code> # Connect TCP socket to controller:<br/>
 drvAsynIPPortConfigure("6K","192.168.200.177:4001",0,0,0)<br/>
</code></p>
<p><code># Create 'controller' object<br/>
 # Arguments:<br/>
 # Port name<br/>
 # Low level comms port name<br/>
 # Low level comms port addr<br/>
 # Number of axes (1 based, including un-used axes)<br/>
 # Moving polling rate<br/>
 # Idle polling rate<br/>
 p6kCreateController("P6K","6K",0,2,500,1000)<br/>
</code></p>
<p><code># Optionally upload a controller configuration<br/>
 # Arguments:<br/>
 # Controller port name<br/>
 # Full path for file<br/>
 p6kUpload("P6K", "/home/controls/motion/bl1a/mcc1/config")<br/>
 </code></p>
<p>The above file must only contain a list of commands with a newline separating each command.</p>
<p>For example: <code><br/>
 ECHO0<br/>
 COMEXC1<br/>
 1DRES25000<br/>
 1ERES4000<br/>
 1ENCCNT1<br/>
 1ESTALL1<br/>
 1ESK1<br/>
 1LH0<br/>
 2DRES25000<br/>
 2ERES4000<br/>
 2LH0<br/>
 2DRFEN1<br/>
 LIMLVL001000000000<br/>
 </code></p>
<p>It is not necessary to upload a controller config file, but it is advantageous to do so in order to easily recover after a power cycle. Otherwise there must be a manual step to configure the controller before running the IOC.</p>
<p>After instantiating the controller object and uploading a config the axis objects must be created:</p>
<p><code> # Create 'axis' objects<br/>
 # Arguments:<br/>
 # Controller port name<br/>
 # Axis number (must be &lt;=number of axes passed into controller object)<br/>
 p6kCreateAxis("P6K",1)<br/>
 p6kCreateAxis("P6K",2)<br/>
 etc. </code></p>
<h3><a class="anchor" id="src_makefile">
IOC src/Makefile</a></h3>
<p>It is only necessary to include this dbd file:</p>
<p><code> parker6kSupport.dbd </code></p>
<p>and this library:</p>
<p><code> parker6kSupport </code></p>
<h3><a class="anchor" id="records">
Additonal database records</a></h3>
<p>The driver can be used with a standard 'asynMotor' motor record. However, it is useful to combine this with several other records to provide functions like:</p>
<ul>
<li>
disabling the motor record </li>
<li>
automatic amplifier power control </li>
<li>
access to driver parameters that are not mapped to motor record fields. </li>
</ul>
<p>To provide these records there are database template files in parker6k:</p>
<p><code>p6k_controller.template</code> - for controller specific control/parameters<br/>
 <code>p6k_axis.template</code> - for axis specific control/parameters<br/>
</p>
<p>There are several functions provided by these templates:</p>
<p>p6k_controller.template: </p>
<ul>
<li>
Read controller error messages and comms errors </li>
<li>
Read state of initial controller config </li>
<li>
Enable simple logging (via stdout) of commands sent to controller </li>
<li>
Deferred moves control </li>
<li>
Low level command/response capability </li>
<li>
An asyn record for debugging and enabling tracing. </li>
</ul>
<p>p6k_axis.template: </p>
<ul>
<li>
Disable motor record if we are in comms error. Usually this is because we have lost network connection or the controller has been power cycled. By default the driver will not automatically reconnect to the controller (Asyn IP port auto reconnect has been turned off). This is because it can be dangerous for a user to move a mis-configured controller. At the very least it can mess up auto save settings by making changes that are autosaved and not able to be reflected on the controller. </li>
<li>
Set a delay time for the driver to indicate 'done moving'. This can be useful to take into account setting time between each move. NOTE: this is different from the motor record DLY if the motor record is doing additional moves like backlash or retries. </li>
<li>
Read axis specific error messages. </li>
<li>
Enable automatic drive enable at the start of each move (with an optional delay time between enabling the amplifier and the start of the move). </li>
<li>
Enable automatic drive disable at the end of the move (with an optional delay time between the end of the move and drive disable). This is implemented in database logic due to the possibility of the motor record doing mutliple moves (so we use DMOV transitions to implement this). </li>
</ul>
<h3><a class="anchor" id="building">
Building and Testing</a></h3>
<p>You may need to modify the files in the top level configure directory for your local site, especially the RELEASE file.</p>
<p>The module was developed using: </p>
<ul>
<li>
EPICS BASE 3.14.12.2 </li>
<li>
ASYN 4-22 </li>
<li>
MOTOR 6-8 </li>
</ul>
<p>In addition, the example IOC was built to include support for autosave and devIocStats.</p>
<h3><a class="anchor" id="Contributions">
Contributions</a></h3>
<p>Originally developed at SNS in 2014 by Matt Pearson. </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 10 Jun 2014 for parker6k by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
