<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>parker6k: /home/mkp/github/parker6k/parker6kApp/src/parker6kAxis.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>/home/mkp/github/parker6k/parker6kApp/src/parker6kAxis.cpp</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *  p6kAxis.cpp</span>
<a name="l00003"></a>00003 <span class="comment"> * </span>
<a name="l00004"></a>00004 <span class="comment"> *  P6K Asyn motor based on the </span>
<a name="l00005"></a>00005 <span class="comment"> *  asynMotorAxis class.</span>
<a name="l00006"></a>00006 <span class="comment"> * </span>
<a name="l00007"></a>00007 <span class="comment"> *  Matt Pearson</span>
<a name="l00008"></a>00008 <span class="comment"> *  26 March 2014</span>
<a name="l00009"></a>00009 <span class="comment"> * </span>
<a name="l00010"></a>00010 <span class="comment"> ********************************************/</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;epicsTime.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;epicsThread.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;epicsExport.h&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;epicsExit.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;epicsString.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;epicsStdio.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;iocsh.h&gt;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;parker6kController.h&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00028"></a>00028 <span class="keyword">using</span> std::cout;
<a name="l00029"></a>00029 <span class="keyword">using</span> std::endl;
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="comment">/* TAS Status Bits (position in char array, not TAS bit position) */</span>
<a name="l00032"></a>00032 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_MOVING_        = 0;
<a name="l00033"></a>00033 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_DIRECTION_     = 1;
<a name="l00034"></a>00034 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_ACCELERATING_  = 2;
<a name="l00035"></a>00035 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_ATVELOCITY_    = 3;
<a name="l00036"></a>00036 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_HOMED_         = 5;
<a name="l00037"></a>00037 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_ABSOLUTE_      = 6;
<a name="l00038"></a>00038 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_CONTINUOUS_    = 7;
<a name="l00039"></a>00039 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_JOG_           = 8;
<a name="l00040"></a>00040 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_JOYSTICK_      = 10;
<a name="l00041"></a>00041 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_STALL_         = 13;
<a name="l00042"></a>00042 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_DRIVE_         = 15;
<a name="l00043"></a>00043 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_DRIVEFAULT_    = 16;
<a name="l00044"></a>00044 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_POSLIM_        = 17;
<a name="l00045"></a>00045 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_NEGLIM_        = 18;
<a name="l00046"></a>00046 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_POSLIMSOFT_    = 20;
<a name="l00047"></a>00047 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_NEGLIMSOFT_    = 21;
<a name="l00048"></a>00048 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_POSERROR_      = 27;
<a name="l00049"></a>00049 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_TARGETZONE_    = 28;
<a name="l00050"></a>00050 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_TARGETTIMEOUT_ = 30;
<a name="l00051"></a>00051 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_GOWHENPEND_    = 31;
<a name="l00052"></a>00052 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_MOVEPEND_      = 33; 
<a name="l00053"></a>00053 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_TAS_PREEMPT_       = 36;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_STEPPER_     = 0;
<a name="l00056"></a>00056 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_SERVO_       = 1;
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_LIM_DISABLE_ = 0;
<a name="l00059"></a>00059 <span class="keyword">const</span> epicsUInt32 p6kAxis::P6K_LIM_ENABLE_  = 3;
<a name="l00060"></a>00060 
<a name="l00064"></a>00064 <span class="keyword">static</span> <span class="keywordtype">void</span> shutdownCallback(<span class="keywordtype">void</span> *pPvt)
<a name="l00065"></a>00065 {
<a name="l00066"></a>00066   <a class="code" href="classp6kController.html">p6kController</a> *pC = <span class="keyword">static_cast&lt;</span><a class="code" href="classp6kController.html">p6kController</a> *<span class="keyword">&gt;</span>(pPvt);
<a name="l00067"></a>00067 
<a name="l00068"></a>00068   pC-&gt;lock();
<a name="l00069"></a>00069   pC-&gt;shuttingDown_ = 1;
<a name="l00070"></a>00070   pC-&gt;unlock();
<a name="l00071"></a>00071 }
<a name="l00072"></a>00072 
<a name="l00079"></a><a class="code" href="classp6kAxis.html#abf4a75d9d744000fd1e2477aa56d54d8">00079</a> <a class="code" href="classp6kAxis.html#abf4a75d9d744000fd1e2477aa56d54d8">p6kAxis::p6kAxis</a>(<a class="code" href="classp6kController.html">p6kController</a> *pC, int32_t axisNo)
<a name="l00080"></a>00080   :   asynMotorAxis(pC, axisNo),
<a name="l00081"></a>00081       pC_(pC)
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::p6kAxis&quot;</span>;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00086"></a>00086 
<a name="l00087"></a>00087   <span class="keywordflow">if</span> (axisNo &gt; pC_-&gt;numAxes_-1) {
<a name="l00088"></a>00088     asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00089"></a>00089               <span class="stringliteral">&quot;%s ERROR: Axis number out of range. Max: %d\n&quot;</span>, 
<a name="l00090"></a>00090               functionName, pC_-&gt;numAxes_-1);
<a name="l00091"></a>00091     <span class="keywordflow">return</span>;
<a name="l00092"></a>00092   }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094   <span class="comment">//Initialize non-static data members</span>
<a name="l00095"></a>00095   deferredPosition_ = 0.0;
<a name="l00096"></a>00096   deferredMove_ = 0;
<a name="l00097"></a>00097   deferredRelative_ = 0;
<a name="l00098"></a>00098   nowTimeSecs_ = 0.0;
<a name="l00099"></a>00099   lastTimeSecs_ = 0.0;
<a name="l00100"></a>00100   doneTimeSecs_ = 0.0;
<a name="l00101"></a>00101   movingLastPoll_ = <span class="keyword">false</span>;
<a name="l00102"></a>00102   delayDoneMove_ = <span class="keyword">false</span>;
<a name="l00103"></a>00103   printNextError_ = <span class="keyword">false</span>;
<a name="l00104"></a>00104   printErrors_ = <span class="keyword">true</span>;
<a name="l00105"></a>00105   commandError_ = <span class="keyword">false</span>;
<a name="l00106"></a>00106   axisError_ = <span class="keyword">false</span>;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108   p6k_cmddir_ = 0;
<a name="l00109"></a>00109   p6k_drfen_ = 0;
<a name="l00110"></a>00110   p6k_encpol_ = 0;
<a name="l00111"></a>00111   p6k_esk_ = 0;
<a name="l00112"></a>00112   p6k_estall_ = 0;
<a name="l00113"></a>00113 
<a name="l00114"></a>00114   <span class="comment">/* Set an EPICS exit handler that will shut down polling before asyn kills the IP sockets */</span>
<a name="l00115"></a>00115   epicsAtExit(shutdownCallback, pC_);
<a name="l00116"></a>00116 
<a name="l00117"></a>00117   <span class="comment">//Initialise some axis specifc parameters</span>
<a name="l00118"></a>00118   <span class="keywordtype">bool</span> paramStatus = <span class="keyword">true</span>;
<a name="l00119"></a>00119   paramStatus = ((setIntegerParam(pC_-&gt;P6K_A_DRES_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00120"></a>00120   paramStatus = ((setIntegerParam(pC_-&gt;P6K_A_ERES_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00121"></a>00121   paramStatus = ((setIntegerParam(pC_-&gt;P6K_A_MaxDigits_, pC_-&gt;P6K_MAX_DIGITS_) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00122"></a>00122   paramStatus = ((setIntegerParam(pC_-&gt;motorStatusHasEncoder_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00123"></a>00123   paramStatus = ((setIntegerParam(pC_-&gt;motorStatusGainSupport_, 1) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00124"></a>00124   paramStatus = ((setStringParam(pC_-&gt;P6K_A_Command_, <span class="stringliteral">&quot; &quot;</span>) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00125"></a>00125   paramStatus = ((setStringParam(pC_-&gt;P6K_A_Response_, <span class="stringliteral">&quot; &quot;</span>) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00126"></a>00126   paramStatus = ((setIntegerParam(pC_-&gt;P6K_A_LS_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00127"></a>00127   paramStatus = ((setIntegerParam(pC_-&gt;P6K_A_LH_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00128"></a>00128   paramStatus = ((setStringParam(pC_-&gt;P6K_A_Error_, <span class="stringliteral">&quot; &quot;</span>) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00129"></a>00129   paramStatus = ((setStringParam(pC_-&gt;P6K_A_MoveError_, <span class="stringliteral">&quot; &quot;</span>) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00130"></a>00130   paramStatus = ((setDoubleParam(pC_-&gt;P6K_A_DelayTime_, 0.0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00131"></a>00131   paramStatus = ((setIntegerParam(pC_-&gt;P6K_A_TAS_DriveFault_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00132"></a>00132   paramStatus = ((setIntegerParam(pC_-&gt;P6K_A_TAS_Timeout_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00133"></a>00133   paramStatus = ((setIntegerParam(pC_-&gt;P6K_A_TAS_PosErr_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00134"></a>00134   paramStatus = ((setIntegerParam(pC_-&gt;P6K_A_AutoDriveEnable_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00135"></a>00135   paramStatus = ((setIntegerParam(pC_-&gt;P6K_A_AutoDriveEnableDelay_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00136"></a>00136   <span class="keywordflow">if</span> (!paramStatus) {
<a name="l00137"></a>00137     asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00138"></a>00138               <span class="stringliteral">&quot;%s Unable To Set Driver Parameters In Constructor. Axis:%d\n&quot;</span>, 
<a name="l00139"></a>00139               functionName, axisNo_);
<a name="l00140"></a>00140   }
<a name="l00141"></a>00141   
<a name="l00142"></a>00142   <span class="comment">//Do an initial poll to get some values from the P6K</span>
<a name="l00143"></a>00143   <span class="keywordflow">if</span> (axisNo_ &gt; 0) {
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (getAxisInitialStatus() != asynSuccess) {
<a name="l00145"></a>00145       asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00146"></a>00146                 <span class="stringliteral">&quot;%s: getAxisInitialStatus failed to return asynSuccess. Controller: %s, Axis: %d.\n&quot;</span>, 
<a name="l00147"></a>00147                 functionName, pC_-&gt;portName, axisNo_);
<a name="l00148"></a>00148       <span class="keywordflow">return</span>;
<a name="l00149"></a>00149     }
<a name="l00150"></a>00150   }
<a name="l00151"></a>00151  
<a name="l00152"></a>00152   callParamCallbacks();
<a name="l00153"></a>00153 
<a name="l00154"></a>00154   <span class="comment">/* Wake up the poller task which will make it do a poll */</span>   
<a name="l00155"></a>00155   pC_-&gt;wakeupPoller();
<a name="l00156"></a>00156  
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00166"></a>00166 asynStatus p6kAxis::readIntParam(<span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, epicsUInt32 param, uint32_t *val)
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168   <span class="keywordtype">char</span> command[P6K_MAXBUF] = {0};
<a name="l00169"></a>00169   <span class="keywordtype">char</span> response[P6K_MAXBUF] = {0};
<a name="l00170"></a>00170   <span class="keywordtype">char</span> scan[P6K_MAXBUF] = {0};
<a name="l00171"></a>00171   uint32_t nvals = 0;
<a name="l00172"></a>00172   uint32_t axisNum = 0;
<a name="l00173"></a>00173   asynStatus status = asynSuccess; 
<a name="l00174"></a>00174 
<a name="l00175"></a>00175   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::readIntParam&quot;</span>;
<a name="l00176"></a>00176   
<a name="l00177"></a>00177   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00178"></a>00178 
<a name="l00179"></a>00179   epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s&quot;</span>, axisNo_, cmd);
<a name="l00180"></a>00180   status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00181"></a>00181   <span class="keywordflow">if</span> (status == asynSuccess) {
<a name="l00182"></a>00182     epicsSnprintf(scan,  P6K_MAXBUF, <span class="stringliteral">&quot;%%d%s%%d&quot;</span>, cmd);
<a name="l00183"></a>00183     nvals = sscanf(response, scan, &amp;axisNum, val);    
<a name="l00184"></a>00184     <span class="keywordflow">if</span> (nvals == 2) {
<a name="l00185"></a>00185       <span class="keywordflow">if</span> (param != 0) {
<a name="l00186"></a>00186         setIntegerParam(param, *val);
<a name="l00187"></a>00187       }
<a name="l00188"></a>00188       status = asynSuccess;
<a name="l00189"></a>00189     } <span class="keywordflow">else</span> {
<a name="l00190"></a>00190       status = asynError;
<a name="l00191"></a>00191     }
<a name="l00192"></a>00192   }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194   <span class="keywordflow">if</span> (status != asynSuccess) {
<a name="l00195"></a>00195     asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00196"></a>00196               <span class="stringliteral">&quot;%s ERROR: Failed to read %s at startup.\n&quot;</span>, functionName, cmd);
<a name="l00197"></a>00197   }
<a name="l00198"></a>00198   
<a name="l00199"></a>00199   <span class="keywordflow">return</span> status;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 } 
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 
<a name="l00211"></a>00211 asynStatus p6kAxis::readDoubleParam(<span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, epicsUInt32 param, <span class="keywordtype">double</span> *val)
<a name="l00212"></a>00212 {
<a name="l00213"></a>00213   <span class="keywordtype">char</span> command[P6K_MAXBUF] = {0};
<a name="l00214"></a>00214   <span class="keywordtype">char</span> response[P6K_MAXBUF] = {0};
<a name="l00215"></a>00215   <span class="keywordtype">char</span> scan[P6K_MAXBUF] = {0};
<a name="l00216"></a>00216   uint32_t nvals = 0;
<a name="l00217"></a>00217   uint32_t axisNum = 0;
<a name="l00218"></a>00218   asynStatus status = asynSuccess; 
<a name="l00219"></a>00219 
<a name="l00220"></a>00220   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::readDoubleParam&quot;</span>;
<a name="l00221"></a>00221   
<a name="l00222"></a>00222   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00223"></a>00223 
<a name="l00224"></a>00224   epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s&quot;</span>, axisNo_, cmd);
<a name="l00225"></a>00225   status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00226"></a>00226   <span class="keywordflow">if</span> (status == asynSuccess) {
<a name="l00227"></a>00227     epicsSnprintf(scan,  P6K_MAXBUF, <span class="stringliteral">&quot;%%d%s%%lf&quot;</span>, cmd);
<a name="l00228"></a>00228     nvals = sscanf(response, scan, &amp;axisNum, val);
<a name="l00229"></a>00229     <span class="keywordflow">if</span> (nvals == 2) {
<a name="l00230"></a>00230       <span class="keywordflow">if</span> (param != 0) {
<a name="l00231"></a>00231         setDoubleParam(param, *val);
<a name="l00232"></a>00232       }
<a name="l00233"></a>00233       status = asynSuccess;
<a name="l00234"></a>00234     } <span class="keywordflow">else</span> {
<a name="l00235"></a>00235       status = asynError;
<a name="l00236"></a>00236     }
<a name="l00237"></a>00237   }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239   <span class="keywordflow">if</span> (status != asynSuccess) {
<a name="l00240"></a>00240     asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00241"></a>00241               <span class="stringliteral">&quot;%s ERROR: Failed to read %s at startup.\n&quot;</span>, functionName, cmd);
<a name="l00242"></a>00242   }
<a name="l00243"></a>00243 
<a name="l00244"></a>00244   <span class="keywordflow">return</span> status;
<a name="l00245"></a>00245 } 
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 
<a name="l00253"></a>00253 asynStatus p6kAxis::getAxisInitialStatus(<span class="keywordtype">void</span>)
<a name="l00254"></a>00254 {
<a name="l00255"></a>00255   uint32_t intVal = 0;
<a name="l00256"></a>00256   <span class="keywordtype">double</span> doubleVal = 0.0;
<a name="l00257"></a>00257   <span class="keywordtype">bool</span> stat = <span class="keyword">true</span>;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::getAxisInitialStatus&quot;</span>;
<a name="l00260"></a>00260 
<a name="l00261"></a>00261   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00262"></a>00262 
<a name="l00263"></a>00263   <span class="keywordflow">if</span> (axisNo_ != 0) {
<a name="l00264"></a>00264 
<a name="l00265"></a>00265     stat = (readIntParam(P6K_CMD_AXSDEF, pC_-&gt;P6K_A_AXSDEF_, &amp;intVal) == asynSuccess) &amp;&amp; stat;
<a name="l00266"></a>00266     <span class="keywordflow">if</span> (stat) {
<a name="l00267"></a>00267       driveType_ = intVal;
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269     stat = (readIntParam(P6K_CMD_DRES, pC_-&gt;P6K_A_DRES_, &amp;intVal) == asynSuccess) &amp;&amp; stat;
<a name="l00270"></a>00270     stat = (readIntParam(P6K_CMD_ERES, pC_-&gt;P6K_A_ERES_, &amp;intVal) == asynSuccess) &amp;&amp; stat;
<a name="l00271"></a>00271     stat = (readIntParam(P6K_CMD_DRIVE, pC_-&gt;motorStatusPowerOn_, &amp;intVal) == asynSuccess) &amp;&amp; stat;
<a name="l00272"></a>00272     stat = (readIntParam(P6K_CMD_ENCCNT, pC_-&gt;motorStatusHasEncoder_, &amp;intVal) == asynSuccess) &amp;&amp; stat;
<a name="l00273"></a>00273     stat = (readIntParam(P6K_CMD_LH, pC_-&gt;P6K_A_LH_, &amp;intVal) == asynSuccess) &amp;&amp; stat;
<a name="l00274"></a>00274     stat = (readIntParam(P6K_CMD_LS, pC_-&gt;P6K_A_LS_, &amp;intVal) == asynSuccess) &amp;&amp; stat;
<a name="l00275"></a>00275     stat = (readDoubleParam(P6K_CMD_LSPOS, pC_-&gt;motorHighLimit_, &amp;doubleVal) == asynSuccess) &amp;&amp; stat;
<a name="l00276"></a>00276     stat = (readDoubleParam(P6K_CMD_LSNEG, pC_-&gt;motorLowLimit_, &amp;doubleVal) == asynSuccess) &amp;&amp; stat;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278     <span class="comment">//Read some params that don&apos;t need to go in paramLib.</span>
<a name="l00279"></a>00279     stat = (readIntParam(P6K_CMD_CMDDIR, 0, &amp;p6k_cmddir_) == asynSuccess) &amp;&amp; stat;
<a name="l00280"></a>00280     stat = (readIntParam(P6K_CMD_DRFEN,  0, &amp;p6k_drfen_) == asynSuccess) &amp;&amp; stat;
<a name="l00281"></a>00281     stat = (readIntParam(P6K_CMD_ENCPOL, 0, &amp;p6k_encpol_) == asynSuccess) &amp;&amp; stat;
<a name="l00282"></a>00282     stat = (readIntParam(P6K_CMD_ESK,    0, &amp;p6k_esk_) == asynSuccess) &amp;&amp; stat;
<a name="l00283"></a>00283     stat = (readIntParam(P6K_CMD_ESTALL, 0, &amp;p6k_estall_) == asynSuccess) &amp;&amp; stat;
<a name="l00284"></a>00284   }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286   <span class="keywordflow">if</span> (!stat) {
<a name="l00287"></a>00287     asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00288"></a>00288               <span class="stringliteral">&quot;%s ERROR: Could not read all axis parameters at startup.\n&quot;</span>, functionName);
<a name="l00289"></a>00289     setIntegerParam(pC_-&gt;motorStatusCommsError_, 1);
<a name="l00290"></a>00290     <span class="keywordflow">return</span> asynError;
<a name="l00291"></a>00291   } <span class="keywordflow">else</span> {
<a name="l00292"></a>00292     printAxisParams();
<a name="l00293"></a>00293     <span class="keywordflow">return</span> asynSuccess;
<a name="l00294"></a>00294   }
<a name="l00295"></a>00295   
<a name="l00296"></a>00296   <span class="keywordflow">return</span> asynSuccess;
<a name="l00297"></a>00297 }
<a name="l00298"></a>00298 
<a name="l00302"></a><a class="code" href="classp6kAxis.html#a6ed1593d3d7a3a55f5cb7abae8b3daf1">00302</a> <a class="code" href="classp6kAxis.html#a6ed1593d3d7a3a55f5cb7abae8b3daf1">p6kAxis::~p6kAxis</a>() 
<a name="l00303"></a>00303 {
<a name="l00304"></a>00304   <span class="comment">//We should never get here.</span>
<a name="l00305"></a>00305 }
<a name="l00306"></a>00306 
<a name="l00310"></a>00310 <span class="keywordtype">void</span> p6kAxis::printAxisParams(<span class="keywordtype">void</span>)
<a name="l00311"></a>00311 {
<a name="l00312"></a>00312   int32_t  intVal = 0;
<a name="l00313"></a>00313   <span class="keywordtype">double</span> doubleVal = 0.0;
<a name="l00314"></a>00314   
<a name="l00315"></a>00315   printf(<span class="stringliteral">&quot;Axis %d\n&quot;</span>, axisNo_);
<a name="l00316"></a>00316   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;P6K_A_AXSDEF_, &amp;intVal);
<a name="l00317"></a>00317   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_AXSDEF<span class="stringliteral">&quot;: %d\n&quot;</span>, intVal);
<a name="l00318"></a>00318   <span class="keywordflow">if</span> (static_cast&lt;epicsUInt32&gt;(intVal) == P6K_STEPPER_) {
<a name="l00319"></a>00319     printf(<span class="stringliteral">&quot;  Stepper Drive\n&quot;</span>);
<a name="l00320"></a>00320   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (static_cast&lt;epicsUInt32&gt;(intVal) == P6K_SERVO_) {
<a name="l00321"></a>00321     printf(<span class="stringliteral">&quot;  Servo Drive\n&quot;</span>);
<a name="l00322"></a>00322   } <span class="keywordflow">else</span> {
<a name="l00323"></a>00323     printf(<span class="stringliteral">&quot;  Unknown Drive Type\n&quot;</span>);
<a name="l00324"></a>00324   }
<a name="l00325"></a>00325   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_CMDDIR<span class="stringliteral">&quot;: %d\n&quot;</span>, p6k_cmddir_);
<a name="l00326"></a>00326   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;P6K_A_DRES_, &amp;intVal);  
<a name="l00327"></a>00327   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_DRES<span class="stringliteral">&quot;: %d\n&quot;</span>, intVal);
<a name="l00328"></a>00328   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_DRFEN<span class="stringliteral">&quot;: %d\n&quot;</span>, p6k_drfen_);
<a name="l00329"></a>00329   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;motorStatusPowerOn_, &amp;intVal);
<a name="l00330"></a>00330   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_DRIVE<span class="stringliteral">&quot;: %d\n&quot;</span>, intVal);
<a name="l00331"></a>00331   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;P6K_A_ERES_, &amp;intVal);
<a name="l00332"></a>00332   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_ERES<span class="stringliteral">&quot;: %d\n&quot;</span>, intVal);
<a name="l00333"></a>00333   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;motorStatusHasEncoder_, &amp;intVal);
<a name="l00334"></a>00334   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_ENCCNT<span class="stringliteral">&quot;: %d\n&quot;</span>, intVal);
<a name="l00335"></a>00335   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_ENCPOL<span class="stringliteral">&quot;: %d\n&quot;</span>, p6k_encpol_);
<a name="l00336"></a>00336   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_ESK<span class="stringliteral">&quot;: %d\n&quot;</span>, p6k_esk_);
<a name="l00337"></a>00337   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_ESTALL<span class="stringliteral">&quot;: %d\n&quot;</span>, p6k_estall_);
<a name="l00338"></a>00338   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;P6K_A_LS_, &amp;intVal);
<a name="l00339"></a>00339   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_LS<span class="stringliteral">&quot;: %d\n&quot;</span>, intVal);
<a name="l00340"></a>00340   <span class="keywordflow">if</span> (static_cast&lt;epicsUInt32&gt;(intVal) != P6K_LIM_ENABLE_) {
<a name="l00341"></a>00341     printf(<span class="stringliteral">&quot;  WARNING: One or both soft limits are disabled.\n&quot;</span>);
<a name="l00342"></a>00342   }
<a name="l00343"></a>00343   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;P6K_A_LH_, &amp;intVal);
<a name="l00344"></a>00344   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_LH<span class="stringliteral">&quot;: %d\n&quot;</span>, intVal);
<a name="l00345"></a>00345   <span class="keywordflow">if</span> (static_cast&lt;epicsUInt32&gt;(intVal) != P6K_LIM_ENABLE_) {
<a name="l00346"></a>00346     printf(<span class="stringliteral">&quot;  WARNING: One or both hard limits are disabled.\n&quot;</span>);
<a name="l00347"></a>00347   }
<a name="l00348"></a>00348   pC_-&gt;getDoubleParam(axisNo_, pC_-&gt;motorHighLimit_, &amp;doubleVal);
<a name="l00349"></a>00349   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_LSPOS<span class="stringliteral">&quot;: %f\n&quot;</span>, doubleVal);
<a name="l00350"></a>00350   pC_-&gt;getDoubleParam(axisNo_, pC_-&gt;motorLowLimit_, &amp;doubleVal);
<a name="l00351"></a>00351   printf(<span class="stringliteral">&quot;  &quot;</span>P6K_CMD_LSNEG<span class="stringliteral">&quot;: %f\n&quot;</span>, doubleVal);
<a name="l00352"></a>00352 
<a name="l00353"></a>00353 }
<a name="l00354"></a>00354 
<a name="l00358"></a><a class="code" href="classp6kAxis.html#a87b21ab183017f23c2d606a0d36fa097">00358</a> asynStatus <a class="code" href="classp6kAxis.html#a87b21ab183017f23c2d606a0d36fa097">p6kAxis::move</a>(<span class="keywordtype">double</span> position, int32_t relative, <span class="keywordtype">double</span> min_velocity, <span class="keywordtype">double</span> max_velocity, <span class="keywordtype">double</span> acceleration)
<a name="l00359"></a>00359 {
<a name="l00360"></a>00360   asynStatus status = asynError;
<a name="l00361"></a>00361   <span class="keywordtype">char</span> command[P6K_MAXBUF]  = {0};
<a name="l00362"></a>00362   <span class="keywordtype">char</span> response[P6K_MAXBUF] = {0};
<a name="l00363"></a>00363   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::move&quot;</span>;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00366"></a>00366 
<a name="l00367"></a>00367   int32_t maxDigits = 0;
<a name="l00368"></a>00368   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;P6K_A_MaxDigits_, &amp;maxDigits);
<a name="l00369"></a>00369 
<a name="l00370"></a>00370   int32_t scale = getScaleFactor();
<a name="l00371"></a>00371   <span class="keywordflow">if</span> (scale == 0) {
<a name="l00372"></a>00372     <span class="keywordflow">return</span> asynError;
<a name="l00373"></a>00373   }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375   <span class="keywordflow">if</span> (autoDriveEnable() != asynSuccess) {
<a name="l00376"></a>00376     <span class="keywordflow">return</span> asynError;
<a name="l00377"></a>00377   }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379   <span class="keywordflow">if</span> (relative &gt; 1) {
<a name="l00380"></a>00380     relative = 1;
<a name="l00381"></a>00381   }
<a name="l00382"></a>00382   epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%d&quot;</span>, axisNo_, P6K_CMD_MA, !relative);
<a name="l00383"></a>00383   status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00384"></a>00384   memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00385"></a>00385 
<a name="l00386"></a>00386   <span class="keywordflow">if</span> (max_velocity != 0) {
<a name="l00387"></a>00387     epicsFloat64 vel = max_velocity / scale;
<a name="l00388"></a>00388     epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%.*f&quot;</span>, axisNo_, P6K_CMD_V, maxDigits, vel);
<a name="l00389"></a>00389     status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00390"></a>00390     memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00391"></a>00391   }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393   <span class="keywordflow">if</span> (acceleration != 0) {
<a name="l00394"></a>00394     <span class="keywordflow">if</span> (max_velocity != 0) {
<a name="l00395"></a>00395       epicsFloat64 accel = acceleration / scale;
<a name="l00396"></a>00396       epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%.*f&quot;</span>, axisNo_, P6K_CMD_A, maxDigits, accel);
<a name="l00397"></a>00397       status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00398"></a>00398       memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00399"></a>00399       
<a name="l00400"></a>00400       <span class="comment">//Set S curve parameters too</span>
<a name="l00401"></a>00401       epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%.*f&quot;</span>, axisNo_, P6K_CMD_AA, maxDigits, accel/2);
<a name="l00402"></a>00402       status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00403"></a>00403       memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00404"></a>00404 
<a name="l00405"></a>00405       epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%.*f&quot;</span>, axisNo_, P6K_CMD_AD, maxDigits, accel);
<a name="l00406"></a>00406       status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00407"></a>00407       memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00408"></a>00408 
<a name="l00409"></a>00409       epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%.*f&quot;</span>, axisNo_, P6K_CMD_ADA, maxDigits, accel);
<a name="l00410"></a>00410       status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00411"></a>00411       memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00412"></a>00412     }
<a name="l00413"></a>00413   }
<a name="l00414"></a>00414   
<a name="l00415"></a>00415   <span class="comment">//Don&apos;t set position if we are doing deferred moves.</span>
<a name="l00416"></a>00416   <span class="comment">//In case we cancel the deferred move.</span>
<a name="l00417"></a>00417   epicsUInt32 pos = <span class="keyword">static_cast&lt;</span>epicsUInt32<span class="keyword">&gt;</span>(position);
<a name="l00418"></a>00418   <span class="keywordflow">if</span> (pC_-&gt;movesDeferred_ == 0) {
<a name="l00419"></a>00419     epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%d&quot;</span>, axisNo_, P6K_CMD_D, pos);
<a name="l00420"></a>00420     status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00421"></a>00421     memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00422"></a>00422     epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s&quot;</span>, axisNo_, P6K_CMD_GO);
<a name="l00423"></a>00423   } <span class="keywordflow">else</span> { <span class="comment">/* deferred moves */</span>
<a name="l00424"></a>00424     deferredPosition_ = pos;
<a name="l00425"></a>00425     deferredMove_ = 1;
<a name="l00426"></a>00426     <span class="comment">//deferredRelative_ = relative; //This is already taken care of on the controller by the MA command</span>
<a name="l00427"></a>00427   }
<a name="l00428"></a>00428         
<a name="l00429"></a>00429   status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00430"></a>00430 
<a name="l00431"></a>00431   <span class="comment">//Check the status of the GO command so we are notified of failed moves.</span>
<a name="l00432"></a>00432   <span class="keywordflow">if</span> (status != asynSuccess) {
<a name="l00433"></a>00433     setStringParam(pC_-&gt;P6K_A_MoveError_, response);
<a name="l00434"></a>00434     commandError_ = <span class="keyword">true</span>;
<a name="l00435"></a>00435   } <span class="keywordflow">else</span> {
<a name="l00436"></a>00436     setStringParam(pC_-&gt;P6K_A_MoveError_, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00437"></a>00437     commandError_ = <span class="keyword">false</span>;
<a name="l00438"></a>00438   }
<a name="l00439"></a>00439   
<a name="l00440"></a>00440   <span class="keywordflow">return</span> status;
<a name="l00441"></a>00441 }
<a name="l00442"></a>00442 
<a name="l00447"></a>00447 int32_t p6kAxis::getScaleFactor(<span class="keywordtype">void</span>)
<a name="l00448"></a>00448 {
<a name="l00449"></a>00449   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::getScaleFactor&quot;</span>;
<a name="l00450"></a>00450 
<a name="l00451"></a>00451   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00452"></a>00452 
<a name="l00453"></a>00453   <span class="comment">//Read DRES and ERES for velocity and accel scaling</span>
<a name="l00454"></a>00454   int32_t dres = 0;
<a name="l00455"></a>00455   int32_t eres = 0;
<a name="l00456"></a>00456   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;P6K_A_DRES_, &amp;dres);
<a name="l00457"></a>00457   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;P6K_A_ERES_, &amp;eres);
<a name="l00458"></a>00458   int32_t scale = 0;
<a name="l00459"></a>00459   <span class="keywordflow">if</span> (driveType_ == P6K_SERVO_) {
<a name="l00460"></a>00460     scale = eres;
<a name="l00461"></a>00461   } <span class="keywordflow">else</span> {
<a name="l00462"></a>00462     scale = dres;
<a name="l00463"></a>00463   }
<a name="l00464"></a>00464   
<a name="l00465"></a>00465   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s DRES=%d, ERES=%d\n&quot;</span>, functionName, dres, eres);
<a name="l00466"></a>00466   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s scale=%d\n&quot;</span>, functionName, scale);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468   <span class="keywordflow">return</span> scale;
<a name="l00469"></a>00469 }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471 
<a name="l00477"></a>00477 asynStatus p6kAxis::autoDriveEnable(<span class="keywordtype">void</span>)
<a name="l00478"></a>00478 {
<a name="l00479"></a>00479   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::autoDriveEnable&quot;</span>;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483   int32_t auto_drive_enable = 0;
<a name="l00484"></a>00484   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;P6K_A_AutoDriveEnable_, &amp;auto_drive_enable);
<a name="l00485"></a>00485   <span class="keywordflow">if</span> (auto_drive_enable == 1) {
<a name="l00486"></a>00486     asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, 
<a name="l00487"></a>00487               <span class="stringliteral">&quot;%s Auto drive enable\n&quot;</span>, functionName);
<a name="l00488"></a>00488     <span class="keywordflow">if</span> (<a class="code" href="classp6kAxis.html#a5cbedc48fd583be88d11b734a5975731">setClosedLoop</a>(<span class="keyword">true</span>) != asynSuccess) {
<a name="l00489"></a>00489       asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00490"></a>00490                 <span class="stringliteral">&quot;%s ERROR: Failed to enable axis %d\n&quot;</span>, functionName, axisNo_);
<a name="l00491"></a>00491       setStringParam(pC_-&gt;P6K_A_MoveError_, <span class="stringliteral">&quot;ERROR: Failed to enable drive&quot;</span>);
<a name="l00492"></a>00492       <span class="keywordflow">return</span> asynError;
<a name="l00493"></a>00493     }
<a name="l00494"></a>00494   }
<a name="l00495"></a>00495 
<a name="l00496"></a>00496   int32_t drive_enable_delay = 0;
<a name="l00497"></a>00497   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;P6K_A_AutoDriveEnableDelay_, &amp;drive_enable_delay);
<a name="l00498"></a>00498   <span class="keywordflow">if</span> (drive_enable_delay &gt; 0) {
<a name="l00499"></a>00499     asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, 
<a name="l00500"></a>00500               <span class="stringliteral">&quot;%s Auto drive enable delay: %d\n&quot;</span>, functionName, drive_enable_delay);
<a name="l00501"></a>00501     epicsThreadSleep(static_cast&lt;double&gt;(drive_enable_delay) / 1000.0);
<a name="l00502"></a>00502   }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504   <span class="keywordflow">return</span> asynSuccess;
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00507"></a>00507 
<a name="l00511"></a><a class="code" href="classp6kAxis.html#aa4e5af85ebd67bfa99ffb6a9b0c931d5">00511</a> asynStatus <a class="code" href="classp6kAxis.html#aa4e5af85ebd67bfa99ffb6a9b0c931d5">p6kAxis::home</a>(<span class="keywordtype">double</span> min_velocity, <span class="keywordtype">double</span> max_velocity, <span class="keywordtype">double</span> acceleration, int32_t forwards)
<a name="l00512"></a>00512 {
<a name="l00513"></a>00513   asynStatus status = asynError;
<a name="l00514"></a>00514   <span class="keywordtype">char</span> command[P6K_MAXBUF] = {0};
<a name="l00515"></a>00515   <span class="keywordtype">char</span> response[P6K_MAXBUF] = {0};
<a name="l00516"></a>00516   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::home&quot;</span>;
<a name="l00517"></a>00517 
<a name="l00518"></a>00518   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520   int32_t maxDigits = 0;
<a name="l00521"></a>00521   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;P6K_A_MaxDigits_, &amp;maxDigits);
<a name="l00522"></a>00522 
<a name="l00523"></a>00523   int32_t scale = getScaleFactor();
<a name="l00524"></a>00524   <span class="keywordflow">if</span> (scale == 0) {
<a name="l00525"></a>00525     <span class="keywordflow">return</span> asynError;
<a name="l00526"></a>00526   }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528   <span class="keywordflow">if</span> (autoDriveEnable() != asynSuccess) {
<a name="l00529"></a>00529     <span class="keywordflow">return</span> asynError;
<a name="l00530"></a>00530   }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532   <span class="keywordflow">if</span> (max_velocity != 0) {
<a name="l00533"></a>00533     epicsFloat64 vel = max_velocity / scale;
<a name="l00534"></a>00534     epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%.*f&quot;</span>, axisNo_, P6K_CMD_HOMV, maxDigits, vel);
<a name="l00535"></a>00535     status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00536"></a>00536     memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00537"></a>00537   }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539   <span class="keywordflow">if</span> (acceleration != 0) {
<a name="l00540"></a>00540     <span class="keywordflow">if</span> (max_velocity != 0) {
<a name="l00541"></a>00541       epicsFloat64 accel = acceleration / scale;
<a name="l00542"></a>00542       epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%.*f&quot;</span>, axisNo_, P6K_CMD_HOMA, maxDigits, accel);
<a name="l00543"></a>00543       status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00544"></a>00544       memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00545"></a>00545       
<a name="l00546"></a>00546       <span class="comment">//Set S curve parameters too</span>
<a name="l00547"></a>00547       epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%.*f&quot;</span>, axisNo_, P6K_CMD_HOMAA, maxDigits, accel/2);
<a name="l00548"></a>00548       status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00549"></a>00549       memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00550"></a>00550 
<a name="l00551"></a>00551       epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%.*f&quot;</span>, axisNo_, P6K_CMD_HOMAD, maxDigits, accel);
<a name="l00552"></a>00552       status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00553"></a>00553       memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00554"></a>00554 
<a name="l00555"></a>00555       epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%.*f&quot;</span>, axisNo_, P6K_CMD_HOMADA, maxDigits, accel);
<a name="l00556"></a>00556       status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00557"></a>00557       memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00558"></a>00558     }
<a name="l00559"></a>00559   }
<a name="l00560"></a>00560 
<a name="l00561"></a>00561   epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%d&quot;</span>, axisNo_, P6K_CMD_HOM, (forwards&gt;0?0:1));
<a name="l00562"></a>00562   status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00563"></a>00563   memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00564"></a>00564 
<a name="l00565"></a>00565 
<a name="l00566"></a>00566   <span class="keywordflow">return</span> status;
<a name="l00567"></a>00567 }
<a name="l00568"></a>00568 
<a name="l00572"></a><a class="code" href="classp6kAxis.html#ace0a936ffe4e3325b0b306bb6c393952">00572</a> asynStatus <a class="code" href="classp6kAxis.html#ace0a936ffe4e3325b0b306bb6c393952">p6kAxis::moveVelocity</a>(<span class="keywordtype">double</span> min_velocity, <span class="keywordtype">double</span> max_velocity, <span class="keywordtype">double</span> acceleration)
<a name="l00573"></a>00573 {
<a name="l00574"></a>00574   asynStatus status = asynError;
<a name="l00575"></a>00575   <span class="comment">//  char command[P6K_MAXBUF]  = {0};</span>
<a name="l00576"></a>00576   <span class="comment">//char response[P6K_MAXBUF] = {0};</span>
<a name="l00577"></a>00577   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::moveVelocity&quot;</span>;
<a name="l00578"></a>00578 
<a name="l00579"></a>00579   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00580"></a>00580 
<a name="l00581"></a>00581   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, <span class="stringliteral">&quot;%s moveVelocity not implemented yet.\n&quot;</span>, functionName);
<a name="l00582"></a>00582 
<a name="l00583"></a>00583   <span class="keywordflow">return</span> status;
<a name="l00584"></a>00584 }
<a name="l00585"></a>00585 
<a name="l00589"></a><a class="code" href="classp6kAxis.html#a5c5744b45ac20b37b840522fde5c3988">00589</a> asynStatus <a class="code" href="classp6kAxis.html#a5c5744b45ac20b37b840522fde5c3988">p6kAxis::setPosition</a>(<span class="keywordtype">double</span> position)
<a name="l00590"></a>00590 {
<a name="l00591"></a>00591   asynStatus asynStatus = asynError;
<a name="l00592"></a>00592   <span class="keywordtype">bool</span> stat = <span class="keyword">true</span>;
<a name="l00593"></a>00593   <span class="keywordtype">char</span> command[P6K_MAXBUF]  = {0};
<a name="l00594"></a>00594   <span class="keywordtype">char</span> response[P6K_MAXBUF] = {0};
<a name="l00595"></a>00595   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::setPosition&quot;</span>;
<a name="l00596"></a>00596   
<a name="l00597"></a>00597   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00598"></a>00598 
<a name="l00599"></a>00599   <span class="comment">/*Set position on motor axis.*/</span>
<a name="l00600"></a>00600   epicsInt32 pos = <span class="keyword">static_cast&lt;</span>epicsInt32<span class="keyword">&gt;</span>(floor(position + 0.5));
<a name="l00601"></a>00601 
<a name="l00602"></a>00602   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, 
<a name="l00603"></a>00603             <span class="stringliteral">&quot;%s: Set axis %d on controller %s to position %d\n&quot;</span>, 
<a name="l00604"></a>00604             functionName, axisNo_, pC_-&gt;portName, pos);
<a name="l00605"></a>00605 
<a name="l00606"></a>00606   epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;!%d%s&quot;</span>, axisNo_, P6K_CMD_S);
<a name="l00607"></a>00607   stat = (pC_-&gt;lowLevelWriteRead(command, response) == asynSuccess) &amp;&amp; stat;
<a name="l00608"></a>00608   memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00609"></a>00609 
<a name="l00610"></a>00610   <span class="keywordflow">if</span> (stat) {
<a name="l00611"></a>00611     epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%d&quot;</span>, axisNo_, P6K_CMD_PSET, pos);
<a name="l00612"></a>00612     stat = (pC_-&gt;lowLevelWriteRead(command, response) == asynSuccess) &amp;&amp; stat;
<a name="l00613"></a>00613   memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00614"></a>00614   }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616   <span class="comment">/*Now set position on encoder axis.*/</span>
<a name="l00617"></a>00617   <span class="keywordflow">if</span> (stat) {             
<a name="l00618"></a>00618     epicsFloat64 encRatio = 0.0;
<a name="l00619"></a>00619     pC_-&gt;getDoubleParam(axisNo_, pC_-&gt;motorEncoderRatio_, &amp;encRatio);
<a name="l00620"></a>00620 
<a name="l00621"></a>00621     <span class="keywordflow">if</span> (encRatio != 0) {
<a name="l00622"></a>00622       epicsInt32 encpos = (epicsInt32) floor((position*encRatio) + 0.5);
<a name="l00623"></a>00623       
<a name="l00624"></a>00624       asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, 
<a name="l00625"></a>00625                 <span class="stringliteral">&quot;%s: Set encoder axis %d on controller %s to position %d, encRatio: %f\n&quot;</span>, 
<a name="l00626"></a>00626                 functionName, axisNo_, pC_-&gt;portName, pos, encRatio);
<a name="l00627"></a>00627       
<a name="l00628"></a>00628       epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%d&quot;</span>, axisNo_, P6K_CMD_PESET, encpos);
<a name="l00629"></a>00629       stat = (pC_-&gt;lowLevelWriteRead(command, response) == asynSuccess) &amp;&amp; stat;
<a name="l00630"></a>00630       memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00631"></a>00631     } <span class="keywordflow">else</span> {
<a name="l00632"></a>00632       asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00633"></a>00633               <span class="stringliteral">&quot;%s: encRation is zero. Not setting encoder position.\n&quot;</span>, 
<a name="l00634"></a>00634               functionName);
<a name="l00635"></a>00635     }
<a name="l00636"></a>00636   }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638   <span class="comment">/*Now do a fast update, to get the new position from the controller.*/</span>
<a name="l00639"></a>00639   <span class="keywordtype">bool</span> moving = <span class="keyword">true</span>;
<a name="l00640"></a>00640   getAxisStatus(&amp;moving);
<a name="l00641"></a>00641  
<a name="l00642"></a>00642   <span class="keywordflow">if</span> (!stat) {
<a name="l00643"></a>00643     asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00644"></a>00644               <span class="stringliteral">&quot;%s: Failed to set position on axis %d on controller %s.\n&quot;</span>, 
<a name="l00645"></a>00645               functionName, axisNo_, pC_-&gt;portName);
<a name="l00646"></a>00646     asynStatus = asynError;
<a name="l00647"></a>00647   } <span class="keywordflow">else</span> {
<a name="l00648"></a>00648     asynStatus = asynSuccess;
<a name="l00649"></a>00649   }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651   <span class="keywordflow">return</span> asynStatus;
<a name="l00652"></a>00652 }
<a name="l00653"></a>00653 
<a name="l00657"></a><a class="code" href="classp6kAxis.html#aa8a80a3e761b5c7df37e200924246d7c">00657</a> asynStatus <a class="code" href="classp6kAxis.html#aa8a80a3e761b5c7df37e200924246d7c">p6kAxis::stop</a>(<span class="keywordtype">double</span> acceleration)
<a name="l00658"></a>00658 {
<a name="l00659"></a>00659   asynStatus status = asynError;
<a name="l00660"></a>00660   <span class="keywordtype">char</span> command[P6K_MAXBUF]  = {0};
<a name="l00661"></a>00661   <span class="keywordtype">char</span> response[P6K_MAXBUF] = {0};
<a name="l00662"></a>00662   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::stopAxis&quot;</span>;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00665"></a>00665 
<a name="l00666"></a>00666   epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;!%d%s&quot;</span>, axisNo_, P6K_CMD_S);
<a name="l00667"></a>00667   status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00668"></a>00668 
<a name="l00669"></a>00669   deferredMove_ = 0;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671   <span class="keywordflow">return</span> status;
<a name="l00672"></a>00672 }
<a name="l00673"></a>00673 
<a name="l00677"></a><a class="code" href="classp6kAxis.html#a23f81b882829e5c4b8a16914f407d0b1">00677</a> asynStatus <a class="code" href="classp6kAxis.html#a23f81b882829e5c4b8a16914f407d0b1">p6kAxis::setEncoderRatio</a>(<span class="keywordtype">double</span> ratio)
<a name="l00678"></a>00678 { 
<a name="l00679"></a>00679   asynStatus status = asynSuccess;
<a name="l00680"></a>00680   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::setEncoderRatio&quot;</span>;
<a name="l00681"></a>00681 
<a name="l00682"></a>00682   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684   status = setDoubleParam(pC_-&gt;motorEncoderRatio_, ratio);
<a name="l00685"></a>00685   <span class="keywordflow">return</span> status;
<a name="l00686"></a>00686 }
<a name="l00687"></a>00687 
<a name="l00691"></a><a class="code" href="classp6kAxis.html#adbf1eae63acf42149a8c1971c7f39741">00691</a> asynStatus <a class="code" href="classp6kAxis.html#adbf1eae63acf42149a8c1971c7f39741">p6kAxis::setHighLimit</a>(<span class="keywordtype">double</span> highLimit)
<a name="l00692"></a>00692 {
<a name="l00693"></a>00693   asynStatus status = asynSuccess;
<a name="l00694"></a>00694   <span class="keywordtype">bool</span> stat = <span class="keyword">true</span>;
<a name="l00695"></a>00695   <span class="keywordtype">char</span> command[P6K_MAXBUF]  = {0};
<a name="l00696"></a>00696   <span class="keywordtype">char</span> response[P6K_MAXBUF] = {0};
<a name="l00697"></a>00697   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::setHighLimit&quot;</span>;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701   epicsInt32 limit = <span class="keyword">static_cast&lt;</span>epicsInt32<span class="keyword">&gt;</span>(floor(highLimit + 0.5));
<a name="l00702"></a>00702 
<a name="l00703"></a>00703   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW,
<a name="l00704"></a>00704             <span class="stringliteral">&quot;%s: Setting high limit on controller %s, axis %d to %d\n&quot;</span>,
<a name="l00705"></a>00705             functionName, pC_-&gt;portName, axisNo_, limit);
<a name="l00706"></a>00706   
<a name="l00707"></a>00707   epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s3&quot;</span>, axisNo_, P6K_CMD_LS);
<a name="l00708"></a>00708   stat = (pC_-&gt;lowLevelWriteRead(command, response) == asynSuccess) &amp;&amp; stat;
<a name="l00709"></a>00709   memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00710"></a>00710   
<a name="l00711"></a>00711   epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%d&quot;</span>, axisNo_, P6K_CMD_LSPOS, limit);
<a name="l00712"></a>00712   stat = (pC_-&gt;lowLevelWriteRead(command, response) == asynSuccess) &amp;&amp; stat;
<a name="l00713"></a>00713   
<a name="l00714"></a>00714   <span class="keywordflow">if</span> (!stat) {
<a name="l00715"></a>00715     asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00716"></a>00716               <span class="stringliteral">&quot;%s: ERROR: Failed to set high limit on controller %s, axis %d\n&quot;</span>,
<a name="l00717"></a>00717               functionName, pC_-&gt;portName, axisNo_);
<a name="l00718"></a>00718     status = asynError;
<a name="l00719"></a>00719   }
<a name="l00720"></a>00720   
<a name="l00721"></a>00721   <span class="keywordflow">return</span> status;
<a name="l00722"></a>00722 }
<a name="l00723"></a>00723 
<a name="l00727"></a><a class="code" href="classp6kAxis.html#a9773f833d8098bb6a99eb07f4a06bd8f">00727</a> asynStatus <a class="code" href="classp6kAxis.html#a9773f833d8098bb6a99eb07f4a06bd8f">p6kAxis::setLowLimit</a>(<span class="keywordtype">double</span> lowLimit)
<a name="l00728"></a>00728 {
<a name="l00729"></a>00729   asynStatus status = asynSuccess;
<a name="l00730"></a>00730   <span class="keywordtype">bool</span> stat = <span class="keyword">true</span>;
<a name="l00731"></a>00731   <span class="keywordtype">char</span> command[P6K_MAXBUF]  = {0};
<a name="l00732"></a>00732   <span class="keywordtype">char</span> response[P6K_MAXBUF] = {0};
<a name="l00733"></a>00733   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::setLowLimit&quot;</span>;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00736"></a>00736 
<a name="l00737"></a>00737   epicsInt32 limit = <span class="keyword">static_cast&lt;</span>epicsInt32<span class="keyword">&gt;</span>(floor(lowLimit + 0.5));
<a name="l00738"></a>00738 
<a name="l00739"></a>00739   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW,
<a name="l00740"></a>00740             <span class="stringliteral">&quot;%s: Setting high limit on controller %s, axis %d to %d\n&quot;</span>,
<a name="l00741"></a>00741             functionName, pC_-&gt;portName, axisNo_, limit);
<a name="l00742"></a>00742   
<a name="l00743"></a>00743   epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s3&quot;</span>, axisNo_, P6K_CMD_LS);
<a name="l00744"></a>00744   stat = (pC_-&gt;lowLevelWriteRead(command, response) == asynSuccess) &amp;&amp; stat;
<a name="l00745"></a>00745   memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00746"></a>00746   
<a name="l00747"></a>00747   epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s%d&quot;</span>, axisNo_, P6K_CMD_LSNEG, limit);
<a name="l00748"></a>00748   stat = (pC_-&gt;lowLevelWriteRead(command, response) == asynSuccess) &amp;&amp; stat;
<a name="l00749"></a>00749   
<a name="l00750"></a>00750   <span class="keywordflow">if</span> (!stat) {
<a name="l00751"></a>00751     asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00752"></a>00752               <span class="stringliteral">&quot;%s: ERROR: Failed to set low limit on controller %s, axis %d\n&quot;</span>,
<a name="l00753"></a>00753               functionName, pC_-&gt;portName, axisNo_);
<a name="l00754"></a>00754     status = asynError;
<a name="l00755"></a>00755   }
<a name="l00756"></a>00756   
<a name="l00757"></a>00757   <span class="keywordflow">return</span> status;
<a name="l00758"></a>00758 }
<a name="l00759"></a>00759 
<a name="l00766"></a><a class="code" href="classp6kAxis.html#a5cbedc48fd583be88d11b734a5975731">00766</a> asynStatus <a class="code" href="classp6kAxis.html#a5cbedc48fd583be88d11b734a5975731">p6kAxis::setClosedLoop</a>(<span class="keywordtype">bool</span> closedLoop)
<a name="l00767"></a>00767 {
<a name="l00768"></a>00768   asynStatus status = asynError;
<a name="l00769"></a>00769   <span class="keywordtype">char</span> command[P6K_MAXBUF]  = {0};
<a name="l00770"></a>00770   <span class="keywordtype">char</span> response[P6K_MAXBUF] = {0};
<a name="l00771"></a>00771   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::setClosedLoop&quot;</span>;
<a name="l00772"></a>00772  
<a name="l00773"></a>00773   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s closedLoop: %d\n&quot;</span>, functionName, closedLoop);
<a name="l00774"></a>00774 
<a name="l00775"></a>00775   int32_t done = 0;
<a name="l00776"></a>00776   pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;motorStatusDone_, &amp;done);
<a name="l00777"></a>00777 
<a name="l00778"></a>00778   <span class="keywordflow">if</span> (done == 1) {
<a name="l00779"></a>00779 
<a name="l00780"></a>00780     <span class="comment">//Check drive status, and dont send anything if we dont need to.</span>
<a name="l00781"></a>00781     int32_t power = 0;
<a name="l00782"></a>00782     pC_-&gt;getIntegerParam(axisNo_, pC_-&gt;motorStatusPowerOn_, &amp;power);
<a name="l00783"></a>00783 
<a name="l00784"></a>00784     <span class="keywordflow">if</span> ((power == 1) &amp;&amp; (closedLoop)) {
<a name="l00785"></a>00785       <span class="keywordflow">return</span> asynSuccess;
<a name="l00786"></a>00786     }
<a name="l00787"></a>00787     <span class="keywordflow">if</span> ((power == 0) &amp;&amp; (!closedLoop)) {
<a name="l00788"></a>00788       <span class="keywordflow">return</span> asynSuccess;
<a name="l00789"></a>00789     }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791     <span class="keywordflow">if</span> (closedLoop) {
<a name="l00792"></a>00792       asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, 
<a name="l00793"></a>00793                 <span class="stringliteral">&quot;%s Drive enable on axis %d\n&quot;</span>, functionName, axisNo_);
<a name="l00794"></a>00794       sprintf(command, <span class="stringliteral">&quot;%d%s1&quot;</span>,  axisNo_, P6K_CMD_DRIVE);
<a name="l00795"></a>00795     } <span class="keywordflow">else</span> {
<a name="l00796"></a>00796       asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, 
<a name="l00797"></a>00797                 <span class="stringliteral">&quot;%s Drive disable on axis %d\n&quot;</span>, functionName, axisNo_);
<a name="l00798"></a>00798       sprintf(command, <span class="stringliteral">&quot;%d%s0&quot;</span>,  axisNo_, P6K_CMD_DRIVE);
<a name="l00799"></a>00799     }
<a name="l00800"></a>00800     status = pC_-&gt;lowLevelWriteRead(command, response);
<a name="l00801"></a>00801     
<a name="l00802"></a>00802     <span class="keywordflow">if</span> (status == asynSuccess) {
<a name="l00803"></a>00803       setIntegerParam(pC_-&gt;motorStatusPowerOn_, static_cast&lt;int&gt;(closedLoop));
<a name="l00804"></a>00804     }
<a name="l00805"></a>00805 
<a name="l00806"></a>00806   }
<a name="l00807"></a>00807   <span class="keywordflow">return</span> status;
<a name="l00808"></a>00808 }
<a name="l00809"></a>00809 
<a name="l00813"></a><a class="code" href="classp6kAxis.html#a988407e14bc4d01536f92efa24cc6b19">00813</a> asynStatus <a class="code" href="classp6kAxis.html#a988407e14bc4d01536f92efa24cc6b19">p6kAxis::poll</a>(<span class="keywordtype">bool</span> *moving)
<a name="l00814"></a>00814 {
<a name="l00815"></a>00815   asynStatus status = asynSuccess;
<a name="l00816"></a>00816   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::poll&quot;</span>;
<a name="l00817"></a>00817 
<a name="l00818"></a>00818   asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s Polling axis: %d\n&quot;</span>, functionName, this-&gt;axisNo_);
<a name="l00819"></a>00819 
<a name="l00820"></a>00820   <span class="keywordflow">if</span> (axisNo_ != 0) {
<a name="l00821"></a>00821 
<a name="l00822"></a>00822     <span class="keywordflow">if</span> (!pC_-&gt;lowLevelPortUser_) {
<a name="l00823"></a>00823       setIntegerParam(pC_-&gt;motorStatusCommsError_, 1);
<a name="l00824"></a>00824       <span class="keywordflow">return</span> asynError;
<a name="l00825"></a>00825     }
<a name="l00826"></a>00826     
<a name="l00827"></a>00827     <span class="comment">//Now poll axis status</span>
<a name="l00828"></a>00828     <span class="keywordflow">if</span> ((status = getAxisStatus(moving)) != asynSuccess) {
<a name="l00829"></a>00829       <span class="keywordflow">if</span> (printErrors_) {
<a name="l00830"></a>00830         asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00831"></a>00831                   <span class="stringliteral">&quot;%s: Controller %s Axis %d. getAxisStatus failed to return asynSuccess.\n&quot;</span>, 
<a name="l00832"></a>00832                   functionName, pC_-&gt;portName, axisNo_);
<a name="l00833"></a>00833       }
<a name="l00834"></a>00834       setStringParam(pC_-&gt;P6K_A_Error_, <span class="stringliteral">&quot;Problem reading axis status&quot;</span>);
<a name="l00835"></a>00835       setIntegerParam(pC_-&gt;motorStatusCommsError_, 1);
<a name="l00836"></a>00836     } <span class="keywordflow">else</span> {
<a name="l00837"></a>00837       <span class="keywordflow">if</span> (!axisError_) {
<a name="l00838"></a>00838         setStringParam(pC_-&gt;P6K_A_Error_, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00839"></a>00839         setIntegerParam(pC_-&gt;motorStatusCommsError_, 0);
<a name="l00840"></a>00840       }
<a name="l00841"></a>00841     }
<a name="l00842"></a>00842   }
<a name="l00843"></a>00843   
<a name="l00844"></a>00844   callParamCallbacks();
<a name="l00845"></a>00845   <span class="keywordflow">return</span> status;
<a name="l00846"></a>00846 }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848 
<a name="l00855"></a>00855 asynStatus p6kAxis::getAxisStatus(<span class="keywordtype">bool</span> *moving)
<a name="l00856"></a>00856 {
<a name="l00857"></a>00857     <span class="keywordtype">char</span> command[P6K_MAXBUF] = {0};
<a name="l00858"></a>00858     <span class="keywordtype">char</span> response[P6K_MAXBUF] = {0};
<a name="l00859"></a>00859     <span class="keywordtype">bool</span> stat = <span class="keyword">true</span>;
<a name="l00860"></a>00860     int32_t nvals = 0;
<a name="l00861"></a>00861     int32_t axisNum = 0;
<a name="l00862"></a>00862     int32_t intVal = 0;
<a name="l00863"></a>00863     <span class="keywordtype">char</span> stringVal[P6K_MAXBUF] = {0};
<a name="l00864"></a>00864     <span class="keywordtype">bool</span> doneMoving = <span class="keyword">false</span>;
<a name="l00865"></a>00865     <span class="keywordtype">bool</span> controllerDoneMoving = <span class="keyword">false</span>;
<a name="l00866"></a>00866     
<a name="l00867"></a>00867     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kAxis::getAxisStatus&quot;</span>;
<a name="l00868"></a>00868     
<a name="l00869"></a>00869     asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00870"></a>00870     
<a name="l00871"></a>00871     axisError_ = <span class="keyword">false</span>;
<a name="l00872"></a>00872 
<a name="l00873"></a>00873     <span class="comment">//Get the time and decide if we want to print errors.</span>
<a name="l00874"></a>00874     <span class="comment">//Crude error message throttling.</span>
<a name="l00875"></a>00875     epicsTimeGetCurrent(&amp;nowTime_);
<a name="l00876"></a>00876     nowTimeSecs_ = nowTime_.secPastEpoch;
<a name="l00877"></a>00877     <span class="keywordflow">if</span> ((nowTimeSecs_ - lastTimeSecs_) &lt; pC_-&gt;P6K_ERROR_PRINT_TIME_) {
<a name="l00878"></a>00878       printErrors_ = <span class="keyword">false</span>;
<a name="l00879"></a>00879     } <span class="keywordflow">else</span> {
<a name="l00880"></a>00880       printErrors_ = <span class="keyword">true</span>;
<a name="l00881"></a>00881       lastTimeSecs_ = nowTimeSecs_;
<a name="l00882"></a>00882     }
<a name="l00883"></a>00883     
<a name="l00884"></a>00884     <span class="keywordflow">if</span> (printNextError_) {
<a name="l00885"></a>00885       printErrors_ = <span class="keyword">true</span>;
<a name="l00886"></a>00886     }
<a name="l00887"></a>00887 
<a name="l00888"></a>00888     <span class="comment">/* Transfer current position and encoder position.*/</span>
<a name="l00889"></a>00889     epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s&quot;</span>, axisNo_, P6K_CMD_TPC);
<a name="l00890"></a>00890     stat = (pC_-&gt;lowLevelWriteRead(command, response) == asynSuccess) &amp;&amp; stat;
<a name="l00891"></a>00891     <span class="keywordflow">if</span> (stat) {
<a name="l00892"></a>00892       nvals = sscanf(response, <span class="stringliteral">&quot;%d&quot;</span>P6K_CMD_TPC<span class="stringliteral">&quot;%d&quot;</span>, &amp;axisNum, &amp;intVal);
<a name="l00893"></a>00893       <span class="keywordflow">if</span> (nvals == 2) {
<a name="l00894"></a>00894         setDoubleParam(pC_-&gt;motorPosition_, intVal);
<a name="l00895"></a>00895       }
<a name="l00896"></a>00896     }
<a name="l00897"></a>00897     memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00898"></a>00898 
<a name="l00899"></a>00899     epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s&quot;</span>, axisNo_, P6K_CMD_TPE);
<a name="l00900"></a>00900     stat = (pC_-&gt;lowLevelWriteRead(command, response) == asynSuccess) &amp;&amp; stat;
<a name="l00901"></a>00901     <span class="keywordflow">if</span> (stat) {
<a name="l00902"></a>00902       nvals = sscanf(response, <span class="stringliteral">&quot;%d&quot;</span>P6K_CMD_TPE<span class="stringliteral">&quot;%d&quot;</span>, &amp;axisNum, &amp;intVal);
<a name="l00903"></a>00903       <span class="keywordflow">if</span> (nvals == 2) {
<a name="l00904"></a>00904         setDoubleParam(pC_-&gt;motorEncoderPosition_, intVal);
<a name="l00905"></a>00905       }
<a name="l00906"></a>00906     }
<a name="l00907"></a>00907     memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00908"></a>00908 
<a name="l00909"></a>00909     <span class="comment">/* Transfer axis status */</span>
<a name="l00910"></a>00910     epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%d%s&quot;</span>, axisNo_, P6K_CMD_TAS);
<a name="l00911"></a>00911     stat = (pC_-&gt;lowLevelWriteRead(command, response) == asynSuccess) &amp;&amp; stat;
<a name="l00912"></a>00912     <span class="keywordflow">if</span> (stat) {
<a name="l00913"></a>00913       nvals = sscanf(response, <span class="stringliteral">&quot;%d&quot;</span>P6K_CMD_TAS<span class="stringliteral">&quot;%s&quot;</span>, &amp;axisNum, stringVal);
<a name="l00914"></a>00914       <span class="keywordflow">if</span> (nvals != 2) {
<a name="l00915"></a>00915         stat = <span class="keyword">false</span>;
<a name="l00916"></a>00916       } 
<a name="l00917"></a>00917     }
<a name="l00918"></a>00918     memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00919"></a>00919 
<a name="l00920"></a>00920     <span class="keywordflow">if</span> (!stat) {
<a name="l00921"></a>00921       <span class="keywordflow">if</span> (printErrors_) {
<a name="l00922"></a>00922         asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00923"></a>00923                   <span class="stringliteral">&quot;%s: ERROR: Problem reading position and status on controller %s, axis %d\n&quot;</span>, 
<a name="l00924"></a>00924                   functionName, pC_-&gt;portName, axisNo_);
<a name="l00925"></a>00925         printNextError_ = <span class="keyword">false</span>;
<a name="l00926"></a>00926       }
<a name="l00927"></a>00927     } <span class="keywordflow">else</span> {
<a name="l00928"></a>00928 
<a name="l00929"></a>00929       <span class="keywordflow">if</span> (deferredMove_) {
<a name="l00930"></a>00930         doneMoving = <span class="keyword">false</span>; 
<a name="l00931"></a>00931       } <span class="keywordflow">else</span> {
<a name="l00932"></a>00932         doneMoving = !(stringVal[P6K_TAS_MOVING_] == pC_-&gt;P6K_ON_);
<a name="l00933"></a>00933       }
<a name="l00934"></a>00934       
<a name="l00935"></a>00935       <span class="keywordflow">if</span> (doneMoving) {
<a name="l00936"></a>00936         <span class="keywordflow">if</span> (driveType_ == P6K_SERVO_) {
<a name="l00937"></a>00937           <span class="keywordtype">bool</span> targetZone = (stringVal[P6K_TAS_TARGETZONE_] == pC_-&gt;P6K_ON_);
<a name="l00938"></a>00938           doneMoving = targetZone &amp;&amp; !(stringVal[P6K_TAS_TARGETTIMEOUT_] == pC_-&gt;P6K_ON_);
<a name="l00939"></a>00939         }
<a name="l00940"></a>00940       }
<a name="l00941"></a>00941 
<a name="l00942"></a>00942       controllerDoneMoving = doneMoving;
<a name="l00943"></a>00943 
<a name="l00944"></a>00944       <span class="comment">//Optionally delay the done moving callback at the end of a move</span>
<a name="l00945"></a>00945       <span class="keywordtype">double</span> delayTime = 0.0;
<a name="l00946"></a>00946       pC_-&gt;getDoubleParam(axisNo_, pC_-&gt;P6K_A_DelayTime_, &amp;delayTime);
<a name="l00947"></a>00947       <span class="keywordflow">if</span> (delayTime &gt; 0) {
<a name="l00948"></a>00948         <span class="keywordflow">if</span> (doneMoving) {
<a name="l00949"></a>00949           <span class="keywordflow">if</span> (movingLastPoll_) {
<a name="l00950"></a>00950             delayDoneMove_ = <span class="keyword">true</span>;
<a name="l00951"></a>00951             doneTimeSecs_ = nowTimeSecs_;
<a name="l00952"></a>00952           }
<a name="l00953"></a>00953           <span class="keywordflow">if</span> (delayDoneMove_) {
<a name="l00954"></a>00954             <span class="keywordflow">if</span> ((nowTimeSecs_ - doneTimeSecs_) &gt; delayTime) {
<a name="l00955"></a>00955               delayDoneMove_ = <span class="keyword">false</span>;
<a name="l00956"></a>00956             }
<a name="l00957"></a>00957           }
<a name="l00958"></a>00958         }
<a name="l00959"></a>00959       }
<a name="l00960"></a>00960       <span class="keywordflow">if</span> (delayDoneMove_) {
<a name="l00961"></a>00961         doneMoving = <span class="keyword">false</span>;
<a name="l00962"></a>00962       }
<a name="l00963"></a>00963       movingLastPoll_ = !controllerDoneMoving;
<a name="l00964"></a>00964       
<a name="l00965"></a>00965       <span class="keywordflow">if</span> (!doneMoving) {
<a name="l00966"></a>00966         *moving = <span class="keyword">true</span>;
<a name="l00967"></a>00967       } <span class="keywordflow">else</span> {
<a name="l00968"></a>00968         *moving = <span class="keyword">false</span>;
<a name="l00969"></a>00969       }
<a name="l00970"></a>00970       
<a name="l00971"></a>00971       <span class="comment">//Set MSTA bits</span>
<a name="l00972"></a>00972       stat = (setIntegerParam(pC_-&gt;motorStatusDone_, 
<a name="l00973"></a>00973               doneMoving) == asynSuccess) &amp;&amp; stat;
<a name="l00974"></a>00974       stat = (setIntegerParam(pC_-&gt;motorStatusMoving_, 
<a name="l00975"></a>00975              (stringVal[P6K_TAS_MOVING_] == pC_-&gt;P6K_ON_)) == asynSuccess) &amp;&amp; stat;
<a name="l00976"></a>00976       stat = (setIntegerParam(pC_-&gt;motorStatusDirection_, 
<a name="l00977"></a>00977              (stringVal[P6K_TAS_DIRECTION_] == pC_-&gt;P6K_OFF_)) == asynSuccess) &amp;&amp; stat;
<a name="l00978"></a>00978       stat = (setIntegerParam(pC_-&gt;motorStatusHighLimit_, 
<a name="l00979"></a>00979             ((stringVal[P6K_TAS_POSLIM_] == pC_-&gt;P6K_ON_) || 
<a name="l00980"></a>00980              (stringVal[P6K_TAS_POSLIMSOFT_] == pC_-&gt;P6K_ON_))) == asynSuccess) &amp;&amp; stat;
<a name="l00981"></a>00981       stat = (setIntegerParam(pC_-&gt;motorStatusLowLimit_, 
<a name="l00982"></a>00982             ((stringVal[P6K_TAS_NEGLIM_] == pC_-&gt;P6K_ON_) || 
<a name="l00983"></a>00983              (stringVal[P6K_TAS_NEGLIMSOFT_] == pC_-&gt;P6K_ON_))) == asynSuccess) &amp;&amp; stat;
<a name="l00984"></a>00984       stat = (setIntegerParam(pC_-&gt;motorStatusHomed_, 
<a name="l00985"></a>00985              (stringVal[P6K_TAS_HOMED_] == pC_-&gt;P6K_ON_)) == asynSuccess) &amp;&amp; stat;
<a name="l00986"></a>00986       stat = (setIntegerParam(pC_-&gt;motorStatusPowerOn_, 
<a name="l00987"></a>00987              (stringVal[P6K_TAS_DRIVE_] == pC_-&gt;P6K_OFF_)) == asynSuccess) &amp;&amp; stat;
<a name="l00988"></a>00988 
<a name="l00989"></a>00989       <span class="comment">//Check TLIM uint32_t from controller object for limit switch status</span>
<a name="l00990"></a>00990       <span class="comment">//We do this so that the axis object can reflect the limit</span>
<a name="l00991"></a>00991       <span class="comment">//switch status even if TAS doesn&apos;t reflect limit switch status. </span>
<a name="l00992"></a>00992       <span class="comment">//To disable this, disable polling TLIM in the controller object.</span>
<a name="l00993"></a>00993       <span class="comment">//NOTE: I don&apos;t check LIMLVL. I assume we are using fail safe inputs</span>
<a name="l00994"></a>00994       <span class="comment">//so that 1=not activated, and 0=activated.</span>
<a name="l00995"></a>00995       int32_t tlim_bits = 0;
<a name="l00996"></a>00996       int32_t tlim_size = 0;
<a name="l00997"></a>00997       pC_-&gt;getIntegerParam(pC_-&gt;P6K_C_TLIM_Bits_, &amp;tlim_bits);
<a name="l00998"></a>00998       stat = (setIntegerParam(pC_-&gt;motorStatusAtHome_, 0) == asynSuccess) &amp;&amp; stat;
<a name="l00999"></a>00999       <span class="keywordflow">if</span> (tlim_bits &gt; 0) {
<a name="l01000"></a>01000         tlim_size = (axisNo_ - 1)*pC_-&gt;P6K_TLIM_SIZE_;
<a name="l01001"></a>01001         if ((tlim_bits &amp; (0x1 &lt;&lt; (tlim_size + pC_-&gt;P6K_TLIM_BIT1_))) == 0) {
<a name="l01002"></a>01002           stat = (setIntegerParam(pC_-&gt;motorStatusHighLimit_, 1) == asynSuccess) &amp;&amp; stat;
<a name="l01003"></a>01003         }
<a name="l01004"></a>01004         <span class="keywordflow">if</span> ((tlim_bits &amp; (0x1 &lt;&lt; (tlim_size + pC_-&gt;P6K_TLIM_BIT2_))) == 0) {
<a name="l01005"></a>01005           stat = (setIntegerParam(pC_-&gt;motorStatusLowLimit_, 1) == asynSuccess) &amp;&amp; stat;
<a name="l01006"></a>01006         }
<a name="l01007"></a>01007         <span class="keywordflow">if</span> (tlim_bits &amp; (0x1 &lt;&lt; (tlim_size + pC_-&gt;P6K_TLIM_BIT3_))) {
<a name="l01008"></a>01008           stat = (setIntegerParam(pC_-&gt;motorStatusAtHome_, 1) == asynSuccess) &amp;&amp; stat;
<a name="l01009"></a>01009         }
<a name="l01010"></a>01010       }
<a name="l01011"></a>01011       
<a name="l01012"></a>01012       <span class="comment">//Set limit error message for users</span>
<a name="l01013"></a>01013       <span class="keywordflow">if</span> ((stringVal[P6K_TAS_POSLIM_] == pC_-&gt;P6K_ON_) || 
<a name="l01014"></a>01014           (stringVal[P6K_TAS_POSLIMSOFT_] == pC_-&gt;P6K_ON_)) {
<a name="l01015"></a>01015         axisError_ = <span class="keyword">true</span>;
<a name="l01016"></a>01016         setStringParam(pC_-&gt;P6K_A_Error_, <span class="stringliteral">&quot;ERROR: High Limit&quot;</span>);
<a name="l01017"></a>01017       }
<a name="l01018"></a>01018       <span class="keywordflow">if</span> ((stringVal[P6K_TAS_NEGLIM_] == pC_-&gt;P6K_ON_) || 
<a name="l01019"></a>01019           (stringVal[P6K_TAS_NEGLIMSOFT_] == pC_-&gt;P6K_ON_)) {
<a name="l01020"></a>01020         axisError_ = <span class="keyword">true</span>;
<a name="l01021"></a>01021         setStringParam(pC_-&gt;P6K_A_Error_, <span class="stringliteral">&quot;ERROR: Low Limit&quot;</span>);
<a name="l01022"></a>01022       }
<a name="l01023"></a>01023 
<a name="l01024"></a>01024       <span class="keywordflow">if</span> (driveType_ == P6K_SERVO_) {
<a name="l01025"></a>01025         stat = (setIntegerParam(pC_-&gt;motorStatusFollowingError_, 
<a name="l01026"></a>01026                (stringVal[P6K_TAS_POSERROR_] == pC_-&gt;P6K_ON_)) == asynSuccess) &amp;&amp; stat;
<a name="l01027"></a>01027       } <span class="keywordflow">else</span> {
<a name="l01028"></a>01028         stat = (setIntegerParam(pC_-&gt;motorStatusFollowingError_, 
<a name="l01029"></a>01029                (stringVal[P6K_TAS_STALL_] == pC_-&gt;P6K_ON_)) == asynSuccess) &amp;&amp; stat;
<a name="l01030"></a>01030       }
<a name="l01031"></a>01031       
<a name="l01032"></a>01032       <span class="keywordflow">if</span> (stringVal[P6K_TAS_STALL_] == pC_-&gt;P6K_ON_) {
<a name="l01033"></a>01033         axisError_ = <span class="keyword">true</span>;
<a name="l01034"></a>01034         setStringParam(pC_-&gt;P6K_A_Error_, <span class="stringliteral">&quot;ERROR: Stall Detected&quot;</span>);
<a name="l01035"></a>01035       }
<a name="l01036"></a>01036       
<a name="l01037"></a>01037       uint32_t problem = 0;
<a name="l01038"></a>01038       <span class="keywordflow">if</span> (commandError_) {
<a name="l01039"></a>01039         problem = 1;
<a name="l01040"></a>01040       }
<a name="l01041"></a>01041 
<a name="l01042"></a>01042       <span class="comment">//We only detect drive fault input when a move is attempted.</span>
<a name="l01043"></a>01043       <span class="comment">//Unless we also poll extended axis status (TASX), which always </span>
<a name="l01044"></a>01044       <span class="comment">//reports drive fault status.</span>
<a name="l01045"></a>01045       <span class="keywordflow">if</span> (stringVal[P6K_TAS_DRIVEFAULT_] == pC_-&gt;P6K_ON_) {
<a name="l01046"></a>01046         stat = (setIntegerParam(pC_-&gt;P6K_A_TAS_DriveFault_, 1) == asynSuccess) &amp;&amp; stat;
<a name="l01047"></a>01047         problem = 1;
<a name="l01048"></a>01048         asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l01049"></a>01049                   <span class="stringliteral">&quot;%s: ERROR: Drive fault on controller %s, axis %d\n&quot;</span>, 
<a name="l01050"></a>01050                   functionName, pC_-&gt;portName, axisNo_);
<a name="l01051"></a>01051       } <span class="keywordflow">else</span> {
<a name="l01052"></a>01052         stat = (setIntegerParam(pC_-&gt;P6K_A_TAS_DriveFault_, 0) == asynSuccess) &amp;&amp; stat;
<a name="l01053"></a>01053       }
<a name="l01054"></a>01054 
<a name="l01055"></a>01055       <span class="keywordflow">if</span> (stringVal[P6K_TAS_TARGETTIMEOUT_] == pC_-&gt;P6K_ON_) {
<a name="l01056"></a>01056         stat = (setIntegerParam(pC_-&gt;P6K_A_TAS_Timeout_, 1) == asynSuccess) &amp;&amp; stat;
<a name="l01057"></a>01057         problem = 1;
<a name="l01058"></a>01058         asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l01059"></a>01059                     <span class="stringliteral">&quot;%s: ERROR: Target timeout on controller %s, axis %d\n&quot;</span>, 
<a name="l01060"></a>01060                   functionName, pC_-&gt;portName, axisNo_);
<a name="l01061"></a>01061       } <span class="keywordflow">else</span> {
<a name="l01062"></a>01062         stat = (setIntegerParam(pC_-&gt;P6K_A_TAS_Timeout_, 0) == asynSuccess) &amp;&amp; stat;
<a name="l01063"></a>01063       }
<a name="l01064"></a>01064 
<a name="l01065"></a>01065       <span class="keywordflow">if</span> (stringVal[P6K_TAS_POSERROR_] == pC_-&gt;P6K_ON_) {
<a name="l01066"></a>01066         stat = (setIntegerParam(pC_-&gt;P6K_A_TAS_PosErr_, 1) == asynSuccess) &amp;&amp; stat;
<a name="l01067"></a>01067         problem = 1;
<a name="l01068"></a>01068         asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l01069"></a>01069                   <span class="stringliteral">&quot;%s: ERROR: Position error on controller %s, axis %d\n&quot;</span>, 
<a name="l01070"></a>01070                   functionName, pC_-&gt;portName, axisNo_);
<a name="l01071"></a>01071       } <span class="keywordflow">else</span> {
<a name="l01072"></a>01072         stat = (setIntegerParam(pC_-&gt;P6K_A_TAS_PosErr_, 0) == asynSuccess) &amp;&amp; stat;
<a name="l01073"></a>01073       }
<a name="l01074"></a>01074 
<a name="l01075"></a>01075       stat = (setIntegerParam(pC_-&gt;motorStatusProblem_, (problem!=0)) == asynSuccess) &amp;&amp; stat;
<a name="l01076"></a>01076       <span class="keywordflow">if</span> (problem == 1) {
<a name="l01077"></a>01077         axisError_ = <span class="keyword">true</span>;
<a name="l01078"></a>01078         setStringParam(pC_-&gt;P6K_A_Error_, <span class="stringliteral">&quot;ERROR: Moved Failed&quot;</span>);
<a name="l01079"></a>01079       }
<a name="l01080"></a>01080 
<a name="l01081"></a>01081       <span class="keywordflow">if</span> (!stat) {
<a name="l01082"></a>01082         <span class="keywordflow">if</span> (printErrors_) {
<a name="l01083"></a>01083           asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l01084"></a>01084                     <span class="stringliteral">&quot;%s: ERROR: Problem setting params on controller %s, axis %d\n&quot;</span>, 
<a name="l01085"></a>01085                     functionName, pC_-&gt;portName, axisNo_);
<a name="l01086"></a>01086           printNextError_ = <span class="keyword">false</span>;
<a name="l01087"></a>01087         }
<a name="l01088"></a>01088       }
<a name="l01089"></a>01089     }
<a name="l01090"></a>01090     
<a name="l01091"></a>01091     <span class="comment">//Clear error print flag for this axis if problem has been removed.</span>
<a name="l01092"></a>01092     <span class="keywordflow">if</span> (stat) {
<a name="l01093"></a>01093       <span class="keywordflow">if</span> (!printErrors_) {
<a name="l01094"></a>01094         asynPrint(pC_-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l01095"></a>01095                   <span class="stringliteral">&quot;%s Problem cleared on controller %s, axis %d\n&quot;</span>, 
<a name="l01096"></a>01096                   functionName, pC_-&gt;portName, axisNo_);
<a name="l01097"></a>01097       }
<a name="l01098"></a>01098       printNextError_ = <span class="keyword">true</span>;
<a name="l01099"></a>01099       <span class="keywordflow">return</span> asynSuccess;
<a name="l01100"></a>01100     }
<a name="l01101"></a>01101     
<a name="l01102"></a>01102     <span class="keywordflow">return</span> asynError;
<a name="l01103"></a>01103 }
<a name="l01104"></a>01104 
<a name="l01105"></a>01105 
<a name="l01106"></a>01106 
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 10 Jun 2014 for parker6k by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
