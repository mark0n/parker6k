<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>parker6k: /home/mkp/github/parker6k/parker6kApp/src/parker6kController.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>/home/mkp/github/parker6k/parker6kApp/src/parker6kController.cpp</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *  p6kController.cpp</span>
<a name="l00003"></a>00003 <span class="comment"> * </span>
<a name="l00004"></a>00004 <span class="comment"> *  P6K Asyn motor based on the </span>
<a name="l00005"></a>00005 <span class="comment"> *  asynMotorController class.</span>
<a name="l00006"></a>00006 <span class="comment"> * </span>
<a name="l00007"></a>00007 <span class="comment"> *  Matt Pearson</span>
<a name="l00008"></a>00008 <span class="comment"> *  26 March 2014</span>
<a name="l00009"></a>00009 <span class="comment"> * </span>
<a name="l00010"></a>00010 <span class="comment"> ********************************************/</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00020"></a>00020 <span class="keyword">using</span> std::cout;
<a name="l00021"></a>00021 <span class="keyword">using</span> std::endl;
<a name="l00022"></a>00022 <span class="keyword">using</span> std::dec;
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;epicsTime.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;epicsThread.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;epicsExport.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;epicsString.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;iocsh.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;drvSup.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;registryFunction.h&gt;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;asynOctetSyncIO.h&quot;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;parker6kController.h&quot;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *driverName = <span class="stringliteral">&quot;parker6k&quot;</span>;
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_MAXBUF_ = P6K_MAXBUF;
<a name="l00039"></a>00039 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_MAXAXES_ = 8;
<a name="l00040"></a>00040 <span class="keyword">const</span> epicsFloat64 p6kController::P6K_TIMEOUT_ = 5.0;
<a name="l00041"></a>00041 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_ERROR_PRINT_TIME_ = 600; <span class="comment">//seconds (this should be set larger when we finish debugging)</span>
<a name="l00042"></a>00042 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_FORCED_FAST_POLLS_ = 10;
<a name="l00043"></a>00043 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_OK_ = 0;
<a name="l00044"></a>00044 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_ERROR_ = 1;
<a name="l00045"></a>00045 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_MAX_DIGITS_ = 2;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keyword">const</span> <span class="keywordtype">char</span> * p6kController::P6K_ASYN_IEOS_ = <span class="stringliteral">&quot;&gt;&quot;</span>;
<a name="l00048"></a>00048 <span class="keyword">const</span> <span class="keywordtype">char</span> * p6kController::P6K_ASYN_OEOS_ = <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="keyword">const</span> <span class="keywordtype">char</span> p6kController::P6K_ON_       = <span class="charliteral">&apos;1&apos;</span>;
<a name="l00051"></a>00051 <span class="keyword">const</span> <span class="keywordtype">char</span> p6kController::P6K_OFF_      = <span class="charliteral">&apos;0&apos;</span>;
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">//TSS Status Bits (position in char array, not TSS bit position) </span>
<a name="l00054"></a>00054 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_TSS_SYSTEMREADY_ = 0;
<a name="l00055"></a>00055 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_TSS_PROGRUNNING_ = 2;
<a name="l00056"></a>00056 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_TSS_IMMEDIATE_   = 3;
<a name="l00057"></a>00057 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_TSS_CMDERROR_    = 12;
<a name="l00058"></a>00058 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_TSS_MEMERROR_    = 26;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="comment">//TLIM Bits (position in char array of first axis)</span>
<a name="l00061"></a>00061 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_TLIM_BIT1_ = 0;
<a name="l00062"></a>00062 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_TLIM_BIT2_ = 1;
<a name="l00063"></a>00063 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_TLIM_BIT3_ = 2;
<a name="l00064"></a>00064 <span class="keyword">const</span> epicsUInt32 p6kController::P6K_TLIM_SIZE_ = 4;
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="comment">//C function prototypes, for the functions that can be called on IOC shell.</span>
<a name="l00067"></a>00067 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l00068"></a>00068   asynStatus p6kCreateController(<span class="keyword">const</span> <span class="keywordtype">char</span> *portName, <span class="keyword">const</span> <span class="keywordtype">char</span> *lowLevelPortName, <span class="keywordtype">int</span> lowLevelPortAddress, 
<a name="l00069"></a>00069                                  <span class="keywordtype">int</span> numAxes, <span class="keywordtype">int</span> movingPollPeriod, <span class="keywordtype">int</span> idlePollPeriod);
<a name="l00070"></a>00070   
<a name="l00071"></a>00071   asynStatus p6kCreateAxis(<span class="keyword">const</span> <span class="keywordtype">char</span> *p6kName, <span class="keywordtype">int</span> axis);
<a name="l00072"></a>00072 
<a name="l00073"></a>00073   asynStatus p6kCreateAxes(<span class="keyword">const</span> <span class="keywordtype">char</span> *p6kName, <span class="keywordtype">int</span> numAxes);
<a name="l00074"></a>00074   
<a name="l00075"></a>00075   asynStatus p6kUpload(<span class="keyword">const</span> <span class="keywordtype">char</span> *p6kName, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename);
<a name="l00076"></a>00076 }
<a name="l00077"></a>00077 
<a name="l00088"></a><a class="code" href="classp6kController.html#ac4f52e54e4f8047ac602b2760aaa0792">00088</a> <a class="code" href="classp6kController.html#ac4f52e54e4f8047ac602b2760aaa0792">p6kController::p6kController</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *portName, <span class="keyword">const</span> <span class="keywordtype">char</span> *lowLevelPortName, <span class="keywordtype">int</span> lowLevelPortAddress, 
<a name="l00089"></a>00089                              <span class="keywordtype">int</span> numAxes, <span class="keywordtype">double</span> movingPollPeriod, <span class="keywordtype">double</span> idlePollPeriod)
<a name="l00090"></a>00090   : asynMotorController(portName, numAxes+1, NUM_MOTOR_DRIVER_PARAMS,
<a name="l00091"></a>00091                         0, <span class="comment">// No additional interfaces</span>
<a name="l00092"></a>00092                         0, <span class="comment">// No addition interrupt interfaces</span>
<a name="l00093"></a>00093                         ASYN_CANBLOCK | ASYN_MULTIDEVICE, 
<a name="l00094"></a>00094                         1, <span class="comment">// autoconnect</span>
<a name="l00095"></a>00095                         0, 0),  <span class="comment">// Default priority and stack size</span>
<a name="l00096"></a>00096     movingPollPeriod_(movingPollPeriod), idlePollPeriod_(idlePollPeriod)
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kController::p6kController&quot;</span>;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100   printf(<span class="stringliteral">&quot;%s: Constructor.\n&quot;</span>, functionName);
<a name="l00101"></a>00101 
<a name="l00102"></a>00102   <span class="comment">//Initialize non static data members</span>
<a name="l00103"></a>00103   lowLevelPortUser_ = NULL;
<a name="l00104"></a>00104   movesDeferred_ = 0;
<a name="l00105"></a>00105   nowTimeSecs_ = 0.0;
<a name="l00106"></a>00106   lastTimeSecs_ = 0.0;
<a name="l00107"></a>00107   printNextError_ = <span class="keyword">false</span>;
<a name="l00108"></a>00108   printErrors_ = <span class="keyword">true</span>;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110   <a class="code" href="classp6kController.html#a2c283d187ff47b5dd24c3fcd68b1cfa3">pAxes_</a> = (<a class="code" href="classp6kAxis.html">p6kAxis</a> **)(asynMotorController::pAxes_);
<a name="l00111"></a>00111 
<a name="l00112"></a>00112   <span class="comment">//Create controller-specific parameters</span>
<a name="l00113"></a>00113   printf(<span class="stringliteral">&quot;%s: Create controller parameters.\n&quot;</span>, functionName);
<a name="l00114"></a>00114   createParam(P6K_C_FirstParamString,       asynParamInt32, &amp;P6K_C_FirstParam_);
<a name="l00115"></a>00115   createParam(P6K_C_GlobalStatusString,     asynParamInt32, &amp;P6K_C_GlobalStatus_);
<a name="l00116"></a>00116   createParam(P6K_C_CommsErrorString,       asynParamInt32, &amp;P6K_C_CommsError_);
<a name="l00117"></a>00117   createParam(P6K_C_CommandString,          asynParamOctet, &amp;P6K_C_Command_);
<a name="l00118"></a>00118   createParam(P6K_C_ResponseString,         asynParamOctet, &amp;P6K_C_Response_);
<a name="l00119"></a>00119   createParam(P6K_C_ErrorString,            asynParamOctet, &amp;P6K_C_Error_);
<a name="l00120"></a>00120   createParam(P6K_C_ConfigString,           asynParamInt32, &amp;P6K_C_Config_);
<a name="l00121"></a>00121   createParam(P6K_C_LogString,              asynParamInt32, &amp;P6K_C_Log_);
<a name="l00122"></a>00122   createParam(P6K_C_TSS_SystemReadyString,  asynParamInt32, &amp;P6K_C_TSS_SystemReady_);
<a name="l00123"></a>00123   createParam(P6K_C_TSS_ProgRunningString,  asynParamInt32, &amp;P6K_C_TSS_ProgRunning_);
<a name="l00124"></a>00124   createParam(P6K_C_TSS_ImmediateString,    asynParamInt32, &amp;P6K_C_TSS_Immediate_);
<a name="l00125"></a>00125   createParam(P6K_C_TSS_CmdErrorString,     asynParamInt32, &amp;P6K_C_TSS_CmdError_);
<a name="l00126"></a>00126   createParam(P6K_C_TSS_MemErrorString,     asynParamInt32, &amp;P6K_C_TSS_MemError_);
<a name="l00127"></a>00127   createParam(P6K_C_TLIM_EnableString,      asynParamInt32, &amp;P6K_C_TLIM_Enable_);
<a name="l00128"></a>00128   createParam(P6K_C_TLIM_BitsString,        asynParamInt32, &amp;P6K_C_TLIM_Bits_);
<a name="l00129"></a>00129   createParam(P6K_C_LastParamString,        asynParamInt32, &amp;P6K_C_LastParam_);
<a name="l00130"></a>00130 
<a name="l00131"></a>00131   <span class="comment">//Create axis specific parameters</span>
<a name="l00132"></a>00132   <span class="comment">//createParam adds the parameters to all param lists automatically (using maxAddr).</span>
<a name="l00133"></a>00133   printf(<span class="stringliteral">&quot;%s: Create axis parameters.\n&quot;</span>, functionName);
<a name="l00134"></a>00134   createParam(P6K_A_DRESString,             asynParamInt32, &amp;P6K_A_DRES_);
<a name="l00135"></a>00135   createParam(P6K_A_ERESString,             asynParamInt32, &amp;P6K_A_ERES_);
<a name="l00136"></a>00136   createParam(P6K_A_DRIVEString,            asynParamInt32, &amp;P6K_A_DRIVE_);
<a name="l00137"></a>00137   createParam(P6K_A_AXSDEFString,           asynParamInt32, &amp;P6K_A_AXSDEF_);
<a name="l00138"></a>00138   createParam(P6K_A_MaxDigitsString,        asynParamInt32, &amp;P6K_A_MaxDigits_);
<a name="l00139"></a>00139   createParam(P6K_A_LSString,               asynParamInt32, &amp;P6K_A_LS_);
<a name="l00140"></a>00140   createParam(P6K_A_LHString,               asynParamInt32, &amp;P6K_A_LH_);
<a name="l00141"></a>00141   createParam(P6K_A_CommandString,          asynParamOctet, &amp;P6K_A_Command_);
<a name="l00142"></a>00142   createParam(P6K_A_ResponseString,         asynParamOctet, &amp;P6K_A_Response_);
<a name="l00143"></a>00143   createParam(P6K_A_ErrorString,            asynParamOctet, &amp;P6K_A_Error_);
<a name="l00144"></a>00144   createParam(P6K_A_MoveErrorString,        asynParamOctet, &amp;P6K_A_MoveError_);
<a name="l00145"></a>00145   createParam(P6K_A_DelayTimeString,        asynParamFloat64, &amp;P6K_A_DelayTime_);
<a name="l00146"></a>00146   createParam(P6K_A_TAS_DriveFaultString,   asynParamInt32, &amp;P6K_A_TAS_DriveFault_);
<a name="l00147"></a>00147   createParam(P6K_A_TAS_TimeoutString,      asynParamInt32, &amp;P6K_A_TAS_Timeout_);
<a name="l00148"></a>00148   createParam(P6K_A_TAS_PosErrString,       asynParamInt32, &amp;P6K_A_TAS_PosErr_);
<a name="l00149"></a>00149   createParam(P6K_A_AutoDriveEnableString,  asynParamInt32, &amp;P6K_A_AutoDriveEnable_);
<a name="l00150"></a>00150   createParam(P6K_A_AutoDriveEnableDelayString,  asynParamInt32, &amp;P6K_A_AutoDriveEnableDelay_);
<a name="l00151"></a>00151 
<a name="l00152"></a>00152   <span class="comment">//Create dummy axis for asyn address 0. This is used for controller parameters.</span>
<a name="l00153"></a>00153   printf(<span class="stringliteral">&quot;%s: Create pAxisZero for controller parameters.\n&quot;</span>, functionName);
<a name="l00154"></a>00154   pAxisZero = <span class="keyword">new</span> <a class="code" href="classp6kAxis.html">p6kAxis</a>(<span class="keyword">this</span>, 0);
<a name="l00155"></a>00155   
<a name="l00156"></a>00156   <span class="comment">//Connect our Asyn user to the low level port that is a parameter to this constructor</span>
<a name="l00157"></a>00157   <span class="comment">//NOTE:</span>
<a name="l00158"></a>00158   <span class="comment">// The P6K will send back a command with a \r\r\n&gt; \n&gt;</span>
<a name="l00159"></a>00159   <span class="comment">// The low level port EOS will remove the first &gt;. </span>
<a name="l00160"></a>00160   <span class="comment">// We will need to deal with the rest in p6kController::lowLevelWriteRead</span>
<a name="l00161"></a>00161   <span class="comment">// Error responses are handled differently, and unfortunately rely on a asyn timeout.</span>
<a name="l00162"></a>00162   printf(<span class="stringliteral">&quot;%s: Connect to low level Asyn port.\n&quot;</span>, functionName);
<a name="l00163"></a>00163   <span class="keywordflow">if</span> (lowLevelPortConnect(lowLevelPortName, lowLevelPortAddress, &amp;lowLevelPortUser_, 
<a name="l00164"></a>00164                           P6K_ASYN_IEOS_, P6K_ASYN_OEOS_) != asynSuccess) {
<a name="l00165"></a>00165     printf(<span class="stringliteral">&quot;%s: Failed to connect to low level asynOctetSyncIO port %s\n&quot;</span>, functionName, lowLevelPortName);
<a name="l00166"></a>00166     setIntegerParam(P6K_C_CommsError_, P6K_ERROR_);
<a name="l00167"></a>00167   } <span class="keywordflow">else</span> {
<a name="l00168"></a>00168     setIntegerParam(P6K_C_CommsError_, P6K_OK_);
<a name="l00169"></a>00169   }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171   <span class="keywordtype">char</span> command[P6K_MAXBUF_] = {0};
<a name="l00172"></a>00172   <span class="keywordtype">char</span> response[P6K_MAXBUF_] = {0};
<a name="l00173"></a>00173 
<a name="l00174"></a>00174   <span class="comment">//Disable command echo</span>
<a name="l00175"></a>00175   epicsSnprintf(command, P6K_MAXBUF_, <span class="stringliteral">&quot;%s0&quot;</span>, P6K_CMD_ECHO);
<a name="l00176"></a>00176   <span class="keywordflow">if</span> (lowLevelWriteRead(command, response) != asynSuccess) {
<a name="l00177"></a>00177     asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00178"></a>00178               <span class="stringliteral">&quot;%s: Setting %s failed.\n&quot;</span>, functionName, P6K_CMD_ECHO);
<a name="l00179"></a>00179     setStringParam(P6K_C_Error_, <span class="stringliteral">&quot;Startup failed. Not starting poller.&quot;</span>);
<a name="l00180"></a>00180   } <span class="keywordflow">else</span> {
<a name="l00181"></a>00181 
<a name="l00182"></a>00182     memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00183"></a>00183     <span class="comment">//Enable continuous command execution mode</span>
<a name="l00184"></a>00184     epicsSnprintf(command, P6K_MAXBUF_, <span class="stringliteral">&quot;%s1&quot;</span>, P6K_CMD_COMEXC);
<a name="l00185"></a>00185     <span class="keywordflow">if</span> (lowLevelWriteRead(command, response) != asynSuccess) {
<a name="l00186"></a>00186       asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00187"></a>00187                 <span class="stringliteral">&quot;%s: Continuous command execution mode (%s) failed.\n&quot;</span>, functionName, P6K_CMD_COMEXC);
<a name="l00188"></a>00188     }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     startPoller();
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="keywordtype">bool</span> paramStatus = <span class="keyword">true</span>;
<a name="l00193"></a>00193     paramStatus = ((setIntegerParam(P6K_C_GlobalStatus_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00194"></a>00194     paramStatus = ((setStringParam(P6K_C_Command_, <span class="stringliteral">&quot; &quot;</span>) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00195"></a>00195     paramStatus = ((setStringParam(P6K_C_Response_, <span class="stringliteral">&quot; &quot;</span>) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00196"></a>00196     paramStatus = ((setStringParam(P6K_C_Error_, <span class="stringliteral">&quot; &quot;</span>) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00197"></a>00197     paramStatus = ((setIntegerParam(P6K_C_Config_, 1) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00198"></a>00198     paramStatus = ((setIntegerParam(P6K_C_Log_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00199"></a>00199     paramStatus = ((setIntegerParam(P6K_C_TSS_SystemReady_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00200"></a>00200     paramStatus = ((setIntegerParam(P6K_C_TSS_ProgRunning_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00201"></a>00201     paramStatus = ((setIntegerParam(P6K_C_TSS_Immediate_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00202"></a>00202     paramStatus = ((setIntegerParam(P6K_C_TSS_CmdError_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00203"></a>00203     paramStatus = ((setIntegerParam(P6K_C_TSS_MemError_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00204"></a>00204     paramStatus = ((setIntegerParam(P6K_C_TLIM_Enable_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00205"></a>00205     paramStatus = ((setIntegerParam(P6K_C_TLIM_Bits_, 0) == asynSuccess) &amp;&amp; paramStatus);
<a name="l00206"></a>00206 
<a name="l00207"></a>00207     callParamCallbacks();
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="keywordflow">if</span> (!paramStatus) {
<a name="l00210"></a>00210       asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00211"></a>00211                 <span class="stringliteral">&quot;%s Unable To Set Driver Parameters In Constructor.\n&quot;</span>, 
<a name="l00212"></a>00212                 functionName);
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215   }
<a name="l00216"></a>00216  
<a name="l00217"></a>00217 }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 p6kController::~p6kController(<span class="keywordtype">void</span>) 
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222   <span class="comment">//Destructor. Should never get here.</span>
<a name="l00223"></a>00223   <span class="keyword">delete</span> pAxisZero;
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 
<a name="l00237"></a>00237 asynStatus p6kController::lowLevelPortConnect(<span class="keyword">const</span> <span class="keywordtype">char</span> *port, <span class="keywordtype">int</span> addr, 
<a name="l00238"></a>00238                                               asynUser **ppasynUser, <span class="keyword">const</span> <span class="keywordtype">char</span> *inputEos, 
<a name="l00239"></a>00239                                               <span class="keyword">const</span> <span class="keywordtype">char</span> *outputEos)
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241   asynStatus status = asynSuccess;
<a name="l00242"></a>00242  
<a name="l00243"></a>00243   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kController::lowLevelPortConnect&quot;</span>;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245   asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00246"></a>00246 
<a name="l00247"></a>00247   status = pasynOctetSyncIO-&gt;connect( port, addr, ppasynUser, NULL);
<a name="l00248"></a>00248   <span class="keywordflow">if</span> (status) {
<a name="l00249"></a>00249     asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00250"></a>00250               <span class="stringliteral">&quot;p6kController::motorAxisAsynConnect: unable to connect to port %s\n&quot;</span>, 
<a name="l00251"></a>00251               port);
<a name="l00252"></a>00252     <span class="keywordflow">return</span> status;
<a name="l00253"></a>00253   }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255   status = pasynOctetSyncIO-&gt;setInputEos(*ppasynUser, inputEos, strlen(inputEos) );
<a name="l00256"></a>00256   <span class="keywordflow">if</span> (status) {
<a name="l00257"></a>00257     asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00258"></a>00258               <span class="stringliteral">&quot;p6kController: unable to set input EOS on %s: %s\n&quot;</span>, 
<a name="l00259"></a>00259               port, (*ppasynUser)-&gt;errorMessage);
<a name="l00260"></a>00260     pasynOctetSyncIO-&gt;disconnect(*ppasynUser);
<a name="l00261"></a>00261     <span class="comment">//Set my low level pasynUser pointer to NULL</span>
<a name="l00262"></a>00262     *ppasynUser = NULL;
<a name="l00263"></a>00263     <span class="keywordflow">return</span> status;
<a name="l00264"></a>00264   }
<a name="l00265"></a>00265   
<a name="l00266"></a>00266   status = pasynOctetSyncIO-&gt;setOutputEos(*ppasynUser, outputEos, strlen(outputEos));
<a name="l00267"></a>00267   <span class="keywordflow">if</span> (status) {
<a name="l00268"></a>00268     asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00269"></a>00269               <span class="stringliteral">&quot;p6kController: unable to set output EOS on %s: %s\n&quot;</span>, 
<a name="l00270"></a>00270               port, (*ppasynUser)-&gt;errorMessage);
<a name="l00271"></a>00271     pasynOctetSyncIO-&gt;disconnect(*ppasynUser);
<a name="l00272"></a>00272     <span class="comment">//Set my low level pasynUser pointer to NULL</span>
<a name="l00273"></a>00273     *ppasynUser = NULL;
<a name="l00274"></a>00274     <span class="keywordflow">return</span> status;
<a name="l00275"></a>00275   }
<a name="l00276"></a>00276   
<a name="l00277"></a>00277   <span class="keywordflow">return</span> status;
<a name="l00278"></a>00278 }
<a name="l00279"></a>00279 
<a name="l00284"></a><a class="code" href="classp6kController.html#a5089092687d5a2ebaf54d5a06d23a185">00284</a> asynStatus <a class="code" href="classp6kController.html#a5089092687d5a2ebaf54d5a06d23a185">p6kController::printConnectedStatus</a>()
<a name="l00285"></a>00285 {
<a name="l00286"></a>00286   asynStatus status = asynSuccess;
<a name="l00287"></a>00287   int32_t asynManagerConnected = 0;
<a name="l00288"></a>00288   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kController::printConnectedStatus&quot;</span>;
<a name="l00289"></a>00289   
<a name="l00290"></a>00290   <span class="keywordflow">if</span> (lowLevelPortUser_) {
<a name="l00291"></a>00291     status = pasynManager-&gt;isConnected(lowLevelPortUser_, &amp;asynManagerConnected);
<a name="l00292"></a>00292       <span class="keywordflow">if</span> (status!=asynSuccess) {
<a name="l00293"></a>00293       asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR,
<a name="l00294"></a>00294                 <span class="stringliteral">&quot;p6kController: Error calling pasynManager::isConnected.\n&quot;</span>);
<a name="l00295"></a>00295       <span class="keywordflow">return</span> status;
<a name="l00296"></a>00296       } <span class="keywordflow">else</span> {
<a name="l00297"></a>00297         asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s isConnected: %d\n&quot;</span>, 
<a name="l00298"></a>00298                   functionName, asynManagerConnected);
<a name="l00299"></a>00299     }
<a name="l00300"></a>00300   }
<a name="l00301"></a>00301   <span class="keywordflow">return</span> status;
<a name="l00302"></a>00302 }
<a name="l00303"></a>00303 
<a name="l00309"></a>00309 asynStatus p6kController::lowLevelWriteRead(<span class="keyword">const</span> <span class="keywordtype">char</span> *command, <span class="keywordtype">char</span> *response)
<a name="l00310"></a>00310 {
<a name="l00311"></a>00311   <span class="keywordtype">bool</span> stat = <span class="keyword">true</span>;
<a name="l00312"></a>00312   int32_t eomReason = 0;
<a name="l00313"></a>00313   <span class="keywordtype">size_t</span> nwrite = 0;
<a name="l00314"></a>00314   <span class="keywordtype">size_t</span> nread = 0;
<a name="l00315"></a>00315   <span class="keywordtype">char</span> temp[P6K_MAXBUF_] = {0};
<a name="l00316"></a>00316   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kController::lowLevelWriteRead&quot;</span>;
<a name="l00317"></a>00317 
<a name="l00318"></a>00318   asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00319"></a>00319   
<a name="l00320"></a>00320   <span class="keywordflow">if</span> (!lowLevelPortUser_) {
<a name="l00321"></a>00321     setIntegerParam(P6K_C_CommsError_, P6K_ERROR_);
<a name="l00322"></a>00322     <span class="keywordflow">return</span> asynError;
<a name="l00323"></a>00323   }
<a name="l00324"></a>00324   
<a name="l00325"></a>00325   asynPrint(lowLevelPortUser_, ASYN_TRACEIO_DRIVER, <span class="stringliteral">&quot;%s: command: %s\n&quot;</span>, functionName, command);
<a name="l00326"></a>00326   asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s: command: %s\n&quot;</span>, functionName, command);   
<a name="l00327"></a>00327 
<a name="l00328"></a>00328   int32_t log = 0;
<a name="l00329"></a>00329   getIntegerParam(P6K_C_Log_, &amp;log);
<a name="l00330"></a>00330   <span class="keywordflow">if</span> (log != 0) {
<a name="l00331"></a>00331     printf(<span class="stringliteral">&quot;%s &gt; %s\n&quot;</span>, this-&gt;portName, command);
<a name="l00332"></a>00332   }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334   memset(response, 0, <span class="keyword">sizeof</span>(response));
<a name="l00335"></a>00335   
<a name="l00336"></a>00336   stat = (pasynOctetSyncIO-&gt;writeRead(lowLevelPortUser_ ,
<a name="l00337"></a>00337                                        command, strlen(command),
<a name="l00338"></a>00338                                        temp, P6K_MAXBUF_,
<a name="l00339"></a>00339                                        P6K_TIMEOUT_,
<a name="l00340"></a>00340                                        &amp;nwrite, &amp;nread, &amp;eomReason ) == asynSuccess) &amp;&amp; stat;
<a name="l00341"></a>00341   
<a name="l00342"></a>00342   <span class="keywordflow">if</span> (!stat) {
<a name="l00343"></a>00343     <span class="keywordflow">if</span> (printErrors_) {
<a name="l00344"></a>00344       asynPrint(lowLevelPortUser_, ASYN_TRACE_ERROR, 
<a name="l00345"></a>00345                 <span class="stringliteral">&quot;%s: Error from pasynOctetSyncIO-&gt;writeRead. command: %s\n&quot;</span>, 
<a name="l00346"></a>00346                 functionName, command);
<a name="l00347"></a>00347     }
<a name="l00348"></a>00348     setIntegerParam(P6K_C_CommsError_, P6K_ERROR_);
<a name="l00349"></a>00349   } <span class="keywordflow">else</span> {
<a name="l00350"></a>00350     setIntegerParam(P6K_C_CommsError_, P6K_OK_);
<a name="l00351"></a>00351   }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353   <span class="comment">//Search for an error response</span>
<a name="l00354"></a>00354   <span class="keywordflow">if</span> (errorResponse(temp, response) == asynSuccess) {
<a name="l00355"></a>00355     asynPrint(lowLevelPortUser_, ASYN_TRACE_ERROR, 
<a name="l00356"></a>00356               <span class="stringliteral">&quot;%s: ERROR: Command %s returned an error: %s\n&quot;</span>, functionName, command, response);
<a name="l00357"></a>00357     stat = <span class="keyword">false</span>;
<a name="l00358"></a>00358   }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360   <span class="comment">//The P6K will send back a command with a \r\r\n&gt; \n&gt;</span>
<a name="l00361"></a>00361   <span class="comment">//The low level port asyn EOS will remove the first &gt;</span>
<a name="l00362"></a>00362   <span class="comment">//(or we removed the error char in the errorResponse function)</span>
<a name="l00363"></a>00363   <span class="comment">//We deal with the rest in this function.</span>
<a name="l00364"></a>00364   stat = (trimResponse(temp, response) == asynSuccess) &amp;&amp; stat;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366   asynPrint(lowLevelPortUser_, ASYN_TRACEIO_DRIVER, <span class="stringliteral">&quot;%s: response: %s\n&quot;</span>, functionName, response); 
<a name="l00367"></a>00367   asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s: response: %s\n&quot;</span>, functionName, response); 
<a name="l00368"></a>00368 
<a name="l00369"></a>00369   <span class="keywordflow">if</span> (log != 0) {
<a name="l00370"></a>00370     printf(<span class="stringliteral">&quot;%s &lt; %s\n&quot;</span>, this-&gt;portName, response);
<a name="l00371"></a>00371   }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   <span class="keywordflow">if</span> (!stat) {
<a name="l00374"></a>00374     <span class="keywordflow">return</span> asynError;
<a name="l00375"></a>00375   }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377   <span class="keywordflow">return</span> asynSuccess;
<a name="l00378"></a>00378 }
<a name="l00379"></a>00379 
<a name="l00389"></a>00389 asynStatus p6kController::errorResponse(<span class="keywordtype">char</span> *input, <span class="keywordtype">char</span> *output)
<a name="l00390"></a>00390 {
<a name="l00391"></a>00391   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *trailer = <span class="stringliteral">&quot;?&quot;</span>;
<a name="l00392"></a>00392   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *header = <span class="stringliteral">&quot;*&quot;</span>;
<a name="l00393"></a>00393   
<a name="l00394"></a>00394   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kController::errorResponse&quot;</span>;
<a name="l00395"></a>00395 
<a name="l00396"></a>00396   asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00397"></a>00397 
<a name="l00398"></a>00398   <span class="keywordflow">if</span> (input == NULL) {
<a name="l00399"></a>00399     <span class="keywordflow">return</span> asynError;
<a name="l00400"></a>00400   }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402   <span class="keywordtype">char</span> *pTrailer = strstr(input, trailer);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404   <span class="keywordflow">if</span> (pTrailer != NULL) {
<a name="l00405"></a>00405     *pTrailer = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00406"></a>00406     <span class="comment">//Remove leading &apos;*&apos; character. Make sure it&apos;s there first.</span>
<a name="l00407"></a>00407     <span class="comment">//For error strings there may be some leading chars before the &apos;*&apos;</span>
<a name="l00408"></a>00408     <span class="keywordtype">char</span> *pHeader = strstr(input, header);
<a name="l00409"></a>00409     <span class="keywordflow">if</span> (pHeader != NULL) {
<a name="l00410"></a>00410       pHeader++;
<a name="l00411"></a>00411       <span class="keywordflow">if</span> (output != NULL) {
<a name="l00412"></a>00412         strncpy(output, pHeader, P6K_MAXBUF_-1);
<a name="l00413"></a>00413       }
<a name="l00414"></a>00414       <span class="keywordflow">return</span> asynSuccess;
<a name="l00415"></a>00415     }
<a name="l00416"></a>00416   } 
<a name="l00417"></a>00417 
<a name="l00418"></a>00418   <span class="comment">//asynError is used to indicate we have not found an error</span>
<a name="l00419"></a>00419   <span class="keywordflow">return</span> asynError;
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 
<a name="l00428"></a>00428 asynStatus p6kController::trimResponse(<span class="keywordtype">char</span> *input, <span class="keywordtype">char</span> *output)
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430   asynStatus status = asynSuccess;
<a name="l00431"></a>00431   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *trailer = <span class="stringliteral">&quot;\r\r\n&quot;</span>;
<a name="l00432"></a>00432   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *smallTrailer = <span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l00433"></a>00433   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *header = <span class="stringliteral">&quot;*&quot;</span>;
<a name="l00434"></a>00434   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kController::trimResponse&quot;</span>;
<a name="l00435"></a>00435 
<a name="l00436"></a>00436   asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00437"></a>00437 
<a name="l00438"></a>00438   <span class="keywordflow">if</span> (input == NULL) {
<a name="l00439"></a>00439     <span class="keywordflow">return</span> asynError;
<a name="l00440"></a>00440   }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442   <span class="keywordtype">char</span> *pTrailer = strstr(input, trailer);
<a name="l00443"></a>00443   <span class="keywordflow">if</span> (pTrailer != NULL) {
<a name="l00444"></a>00444     *pTrailer = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00445"></a>00445   } <span class="keywordflow">else</span> {
<a name="l00446"></a>00446     <span class="comment">//Try the smallTrailer instead</span>
<a name="l00447"></a>00447     pTrailer = strstr(input, smallTrailer);
<a name="l00448"></a>00448     <span class="keywordflow">if</span> (pTrailer != NULL) {
<a name="l00449"></a>00449       *pTrailer = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00450"></a>00450     } <span class="keywordflow">else</span> {
<a name="l00451"></a>00451       <span class="keywordflow">if</span> (printErrors_) {
<a name="l00452"></a>00452         asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00453"></a>00453                   <span class="stringliteral">&quot;%s Could not find correct trailer.\n&quot;</span>, functionName);
<a name="l00454"></a>00454       }
<a name="l00455"></a>00455       status = asynError;
<a name="l00456"></a>00456     }
<a name="l00457"></a>00457   }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459   <span class="comment">//Remove leading &apos;*&apos; character. Make sure it&apos;s there first.</span>
<a name="l00460"></a>00460   <span class="comment">//Occasionally there may be some leading chars before the &apos;*&apos;, eg a space.</span>
<a name="l00461"></a>00461   <span class="keywordtype">char</span> *pHeader = strstr(input, header);
<a name="l00462"></a>00462   <span class="keywordflow">if</span> (pHeader != NULL) {
<a name="l00463"></a>00463     pHeader++;
<a name="l00464"></a>00464     <span class="keywordflow">if</span> (output != NULL) {
<a name="l00465"></a>00465       strncpy(output, pHeader, P6K_MAXBUF_-1);
<a name="l00466"></a>00466     }
<a name="l00467"></a>00467   }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469   <span class="keywordflow">return</span> status;
<a name="l00470"></a>00470 }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472 
<a name="l00476"></a><a class="code" href="classp6kController.html#ae352b601eee75d91883b6955fafa25c8">00476</a> <span class="keywordtype">void</span> <a class="code" href="classp6kController.html#ae352b601eee75d91883b6955fafa25c8">p6kController::report</a>(FILE *fp, <span class="keywordtype">int</span> level)
<a name="l00477"></a>00477 {
<a name="l00478"></a>00478   int32_t axis = 0;
<a name="l00479"></a>00479   <a class="code" href="classp6kAxis.html">p6kAxis</a> *pAxis = NULL;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   fprintf(fp, <span class="stringliteral">&quot;p6k motor driver %s, numAxes=%d, moving poll period=%f, idle poll period=%f\n&quot;</span>, 
<a name="l00482"></a>00482           this-&gt;portName, numAxes_, movingPollPeriod_, idlePollPeriod_);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484   <span class="keywordflow">if</span> (level &gt; 0) {
<a name="l00485"></a>00485     <span class="keywordflow">for</span> (axis=0; axis&lt;numAxes_; axis++) {
<a name="l00486"></a>00486       pAxis = <a class="code" href="classp6kController.html#a0790d66b39dbebbb6265bcabb167e3a5">getAxis</a>(axis);
<a name="l00487"></a>00487       <span class="keywordflow">if</span> (!pAxis) <span class="keywordflow">continue</span>;
<a name="l00488"></a>00488       fprintf(fp, <span class="stringliteral">&quot;  axis %d\n&quot;</span>, 
<a name="l00489"></a>00489               pAxis-&gt;axisNo_);
<a name="l00490"></a>00490     }
<a name="l00491"></a>00491   }
<a name="l00492"></a>00492 
<a name="l00493"></a>00493   <span class="comment">// Call the base class method</span>
<a name="l00494"></a>00494   <a class="code" href="classp6kController.html#ae352b601eee75d91883b6955fafa25c8">asynMotorController::report</a>(fp, level);
<a name="l00495"></a>00495 }
<a name="l00496"></a>00496 
<a name="l00503"></a><a class="code" href="classp6kController.html#a9a0b81dabca6419fafe18f36f9abb2e9">00503</a> asynStatus <a class="code" href="classp6kController.html#a9a0b81dabca6419fafe18f36f9abb2e9">p6kController::writeFloat64</a>(asynUser *pasynUser, epicsFloat64 value)
<a name="l00504"></a>00504 {
<a name="l00505"></a>00505   <span class="keywordtype">int</span> function = pasynUser-&gt;reason;
<a name="l00506"></a>00506   <span class="keywordtype">bool</span> status = <span class="keyword">true</span>;
<a name="l00507"></a>00507   <a class="code" href="classp6kAxis.html">p6kAxis</a> *pAxis = NULL;
<a name="l00508"></a>00508         
<a name="l00509"></a>00509   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kController::writeFloat64&quot;</span>;
<a name="l00510"></a>00510 
<a name="l00511"></a>00511   asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00512"></a>00512 
<a name="l00513"></a>00513   pAxis = this-&gt;<a class="code" href="classp6kController.html#a0790d66b39dbebbb6265bcabb167e3a5">getAxis</a>(pasynUser);
<a name="l00514"></a>00514   <span class="keywordflow">if</span> (!pAxis) {
<a name="l00515"></a>00515     <span class="keywordflow">return</span> asynError;
<a name="l00516"></a>00516   }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518   <span class="comment">/* Set the parameter and readback in the parameter library. */</span>
<a name="l00519"></a>00519   status = (pAxis-&gt;setDoubleParam(function, value) == asynSuccess) &amp;&amp; status;
<a name="l00520"></a>00520 
<a name="l00521"></a>00521   <span class="keywordflow">if</span> (function == P6K_A_DelayTime_) {
<a name="l00522"></a>00522     <span class="keywordflow">if</span> (value &lt; 0.0) {
<a name="l00523"></a>00523       asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00524"></a>00524                 <span class="stringliteral">&quot;%s: ERROR: forcing done moving delay time to be &gt;=0. Axis %d\n&quot;</span>, 
<a name="l00525"></a>00525                 functionName, pAxis-&gt;axisNo_);
<a name="l00526"></a>00526       value = 0.0;
<a name="l00527"></a>00527     }
<a name="l00528"></a>00528   }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530   <span class="comment">//Call base class method. This will handle callCallbacks even if the function was handled here.</span>
<a name="l00531"></a>00531   status = (<a class="code" href="classp6kController.html#a9a0b81dabca6419fafe18f36f9abb2e9">asynMotorController::writeFloat64</a>(pasynUser, value) == asynSuccess) &amp;&amp; status;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533   <span class="keywordflow">if</span> (!status) {
<a name="l00534"></a>00534     setIntegerParam(pAxis-&gt;axisNo_, this-&gt;motorStatusCommsError_, P6K_ERROR_);
<a name="l00535"></a>00535     <span class="keywordflow">return</span> asynError;
<a name="l00536"></a>00536   } <span class="keywordflow">else</span> {
<a name="l00537"></a>00537     setIntegerParam(pAxis-&gt;axisNo_, this-&gt;motorStatusCommsError_, P6K_OK_);
<a name="l00538"></a>00538   }
<a name="l00539"></a>00539 
<a name="l00540"></a>00540   <span class="keywordflow">return</span> asynSuccess;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542 }
<a name="l00543"></a>00543 
<a name="l00550"></a><a class="code" href="classp6kController.html#a9130075d7f114acc2a35a53a85b5431a">00550</a> asynStatus <a class="code" href="classp6kController.html#a9130075d7f114acc2a35a53a85b5431a">p6kController::writeInt32</a>(asynUser *pasynUser, epicsInt32 value)
<a name="l00551"></a>00551 {
<a name="l00552"></a>00552   <span class="keywordtype">int</span> function = pasynUser-&gt;reason;
<a name="l00553"></a>00553   <span class="keywordtype">bool</span> status = <span class="keyword">true</span>;
<a name="l00554"></a>00554   <a class="code" href="classp6kAxis.html">p6kAxis</a> *pAxis = NULL;
<a name="l00555"></a>00555   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kController::writeInt32&quot;</span>;
<a name="l00556"></a>00556 
<a name="l00557"></a>00557   asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00558"></a>00558 
<a name="l00559"></a>00559   pAxis = this-&gt;<a class="code" href="classp6kController.html#a0790d66b39dbebbb6265bcabb167e3a5">getAxis</a>(pasynUser);
<a name="l00560"></a>00560   <span class="keywordflow">if</span> (!pAxis) {
<a name="l00561"></a>00561     <span class="keywordflow">return</span> asynError;
<a name="l00562"></a>00562   } 
<a name="l00563"></a>00563 
<a name="l00564"></a>00564   <span class="keywordflow">if</span> (function == P6K_A_AutoDriveEnableDelay_) {
<a name="l00565"></a>00565     <span class="keywordflow">if</span> (value &lt; 0) {
<a name="l00566"></a>00566       asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00567"></a>00567                 <span class="stringliteral">&quot;%s: ERROR: forcing drive enable to be &gt;=0. Axis %d\n&quot;</span>, 
<a name="l00568"></a>00568                 functionName, pAxis-&gt;axisNo_);
<a name="l00569"></a>00569       value = 0;
<a name="l00570"></a>00570     }
<a name="l00571"></a>00571   }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573   status = (pAxis-&gt;setIntegerParam(function, value) == asynSuccess) &amp;&amp; status;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575   <span class="comment">//Call base class method. This will handle callCallbacks even if the function was handled here.</span>
<a name="l00576"></a>00576   status = (<a class="code" href="classp6kController.html#a9130075d7f114acc2a35a53a85b5431a">asynMotorController::writeInt32</a>(pasynUser, value) == asynSuccess) &amp;&amp; status;
<a name="l00577"></a>00577   
<a name="l00578"></a>00578   <span class="keywordflow">if</span> (!status) {
<a name="l00579"></a>00579     setIntegerParam(pAxis-&gt;axisNo_, this-&gt;motorStatusCommsError_, P6K_ERROR_);
<a name="l00580"></a>00580     <span class="keywordflow">return</span> asynError;
<a name="l00581"></a>00581   } <span class="keywordflow">else</span> {
<a name="l00582"></a>00582     setIntegerParam(pAxis-&gt;axisNo_, this-&gt;motorStatusCommsError_, P6K_OK_);
<a name="l00583"></a>00583   }
<a name="l00584"></a>00584 
<a name="l00585"></a>00585   <span class="keywordflow">return</span> asynSuccess;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587 }
<a name="l00588"></a>00588 
<a name="l00597"></a><a class="code" href="classp6kController.html#a673297b9788a7a52afb9ed452eb7c03e">00597</a> asynStatus <a class="code" href="classp6kController.html#a673297b9788a7a52afb9ed452eb7c03e">p6kController::writeOctet</a>(asynUser *pasynUser, <span class="keyword">const</span> <span class="keywordtype">char</span> *value, 
<a name="l00598"></a>00598                                     <span class="keywordtype">size_t</span> nChars, <span class="keywordtype">size_t</span> *nActual)
<a name="l00599"></a>00599 {
<a name="l00600"></a>00600     <span class="keywordtype">int</span> function = pasynUser-&gt;reason;
<a name="l00601"></a>00601     asynStatus status = asynSuccess;
<a name="l00602"></a>00602     <a class="code" href="classp6kAxis.html">p6kAxis</a> *pAxis = NULL;
<a name="l00603"></a>00603     <span class="keywordtype">char</span> command[P6K_MAXBUF_] = {0};
<a name="l00604"></a>00604     <span class="keywordtype">char</span> response[P6K_MAXBUF_] = {0};
<a name="l00605"></a>00605     <span class="keywordtype">char</span> error[P6K_MAXBUF_] = {0};
<a name="l00606"></a>00606     <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;parker6kController::writeOctet&quot;</span>;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s.\n&quot;</span>, functionName);
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     pAxis = this-&gt;<a class="code" href="classp6kController.html#a0790d66b39dbebbb6265bcabb167e3a5">getAxis</a>(pasynUser);
<a name="l00611"></a>00611     <span class="keywordflow">if</span> (!pAxis) {
<a name="l00612"></a>00612       <span class="keywordflow">return</span> asynError;
<a name="l00613"></a>00613     } 
<a name="l00614"></a>00614     
<a name="l00615"></a>00615     <span class="keywordflow">if</span> (function == P6K_C_Command_) {
<a name="l00616"></a>00616       <span class="comment">//Send command to controller</span>
<a name="l00617"></a>00617       epicsSnprintf(command, P6K_MAXBUF_, <span class="stringliteral">&quot;%s&quot;</span>, value);
<a name="l00618"></a>00618       <span class="keywordflow">if</span> (lowLevelWriteRead(command, response) != asynSuccess) {
<a name="l00619"></a>00619         epicsSnprintf(error, P6K_MAXBUF_, <span class="stringliteral">&quot;Command %s failed&quot;</span>, command);
<a name="l00620"></a>00620         asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00621"></a>00621                   <span class="stringliteral">&quot;%s: %s.\n&quot;</span>, functionName, error);
<a name="l00622"></a>00622         setStringParam(P6K_C_Error_, error);
<a name="l00623"></a>00623         setStringParam(P6K_C_Response_, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00624"></a>00624       } <span class="keywordflow">else</span> {
<a name="l00625"></a>00625         setStringParam(P6K_C_Response_, response);
<a name="l00626"></a>00626         setStringParam(P6K_C_Error_, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00627"></a>00627       }
<a name="l00628"></a>00628     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (function == P6K_A_Command_) {
<a name="l00629"></a>00629       <span class="comment">//Send axis specific command to controller. </span>
<a name="l00630"></a>00630       <span class="comment">//This adds on the axis number to the command</span>
<a name="l00631"></a>00631       <span class="comment">//epicsSnprintf(command, P6K_MAXBUF_, &quot;%d%s&quot;, pAxis-&gt;axisNo_, value);</span>
<a name="l00632"></a>00632       <span class="comment">//if (lowLevelWriteRead(command, response) != asynSuccess) {</span>
<a name="l00633"></a>00633       <span class="comment">//asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, </span>
<a name="l00634"></a>00634       <span class="comment">//          &quot;%s: Command %s failed for axis %d.\n&quot;, functionName, command, pAxis-&gt;axisNo_);</span>
<a name="l00635"></a>00635       <span class="comment">//} else {</span>
<a name="l00636"></a>00636       <span class="comment">//        setStringParam(P6K_A_Response_, response);</span>
<a name="l00637"></a>00637       <span class="comment">//}</span>
<a name="l00638"></a>00638     } <span class="keywordflow">else</span> {
<a name="l00639"></a>00639       status = <a class="code" href="classp6kController.html#a673297b9788a7a52afb9ed452eb7c03e">asynMotorController::writeOctet</a>(pasynUser, value, nChars, nActual);
<a name="l00640"></a>00640     }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642     <span class="keywordflow">if</span> (status != asynSuccess) {
<a name="l00643"></a>00643       callParamCallbacks();
<a name="l00644"></a>00644       <span class="keywordflow">return</span> asynError;
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646     
<a name="l00647"></a>00647     <span class="comment">/* Set the parameter in the parameter library. */</span>
<a name="l00648"></a>00648     status = (asynStatus)setStringParam(function, (<span class="keywordtype">char</span> *)value);
<a name="l00649"></a>00649     <span class="comment">/* Do callbacks so higher layers see any changes */</span>
<a name="l00650"></a>00650     status = (asynStatus)callParamCallbacks();
<a name="l00651"></a>00651 
<a name="l00652"></a>00652     <span class="keywordflow">if</span> (status!=asynSuccess) {
<a name="l00653"></a>00653       asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00654"></a>00654               <span class="stringliteral">&quot;%s Error Setting Parameter. asynUser-&gt;reason: %d\n&quot;</span>, 
<a name="l00655"></a>00655               functionName, function);
<a name="l00656"></a>00656     }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658     *nActual = nChars;
<a name="l00659"></a>00659     <span class="keywordflow">return</span> status;
<a name="l00660"></a>00660 }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662 
<a name="l00666"></a><a class="code" href="classp6kController.html#a0790d66b39dbebbb6265bcabb167e3a5">00666</a> <a class="code" href="classp6kAxis.html">p6kAxis</a>* <a class="code" href="classp6kController.html#a0790d66b39dbebbb6265bcabb167e3a5">p6kController::getAxis</a>(asynUser *pasynUser)
<a name="l00667"></a>00667 {
<a name="l00668"></a>00668   int32_t axisNo = 0;
<a name="l00669"></a>00669     
<a name="l00670"></a>00670   getAddress(pasynUser, &amp;axisNo);
<a name="l00671"></a>00671   <span class="keywordflow">return</span> <a class="code" href="classp6kController.html#a0790d66b39dbebbb6265bcabb167e3a5">getAxis</a>(axisNo);
<a name="l00672"></a>00672 }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674 
<a name="l00675"></a>00675 
<a name="l00679"></a><a class="code" href="classp6kController.html#a1895dba80778089467a1a5d4554fd4bb">00679</a> <a class="code" href="classp6kAxis.html">p6kAxis</a>* <a class="code" href="classp6kController.html#a0790d66b39dbebbb6265bcabb167e3a5">p6kController::getAxis</a>(<span class="keywordtype">int</span> axisNo)
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681   <span class="keywordflow">if</span> ((axisNo &lt; 0) || (axisNo &gt;= numAxes_)) <span class="keywordflow">return</span> NULL;
<a name="l00682"></a>00682   <span class="keywordflow">return</span> <a class="code" href="classp6kController.html#a2c283d187ff47b5dd24c3fcd68b1cfa3">pAxes_</a>[axisNo];
<a name="l00683"></a>00683 }
<a name="l00684"></a>00684 
<a name="l00689"></a>00689 asynStatus p6kController::startPoller(<span class="keywordtype">void</span>)
<a name="l00690"></a>00690 {
<a name="l00691"></a>00691   asynStatus status = asynError;
<a name="l00692"></a>00692   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kController::startPoller&quot;</span>;
<a name="l00693"></a>00693 
<a name="l00694"></a>00694   printf(<span class="stringliteral">&quot;%s: Starting poller.\n&quot;</span>, functionName);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696   status = asynMotorController::startPoller(movingPollPeriod_, idlePollPeriod_, P6K_FORCED_FAST_POLLS_);
<a name="l00697"></a>00697 
<a name="l00698"></a>00698   <span class="keywordflow">return</span> status;
<a name="l00699"></a>00699 }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701 
<a name="l00706"></a><a class="code" href="classp6kController.html#abc19f869fb74f3854cd9a664b3e35ded">00706</a> asynStatus <a class="code" href="classp6kController.html#abc19f869fb74f3854cd9a664b3e35ded">p6kController::poll</a>()
<a name="l00707"></a>00707 {
<a name="l00708"></a>00708   <span class="keywordtype">char</span> command[P6K_MAXBUF] = {0};
<a name="l00709"></a>00709   <span class="keywordtype">char</span> response[P6K_MAXBUF] = {0};
<a name="l00710"></a>00710   <span class="keywordtype">bool</span> stat = <span class="keyword">true</span>;
<a name="l00711"></a>00711   int32_t nvals = 0;
<a name="l00712"></a>00712   <span class="keywordtype">char</span> stringVal[P6K_MAXBUF] = {0};
<a name="l00713"></a>00713   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kController::poll&quot;</span>;
<a name="l00714"></a>00714 
<a name="l00715"></a>00715   asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00716"></a>00716 
<a name="l00717"></a>00717   <span class="keywordflow">if</span> (!lowLevelPortUser_) {
<a name="l00718"></a>00718     <span class="keywordflow">return</span> asynError;
<a name="l00719"></a>00719   }
<a name="l00720"></a>00720 
<a name="l00721"></a>00721   <span class="comment">/* Get the time and decide if we want to print errors.*/</span>
<a name="l00722"></a>00722   epicsTimeGetCurrent(&amp;nowTime_);
<a name="l00723"></a>00723   nowTimeSecs_ = nowTime_.secPastEpoch;
<a name="l00724"></a>00724   <span class="keywordflow">if</span> ((nowTimeSecs_ - lastTimeSecs_) &lt; P6K_ERROR_PRINT_TIME_) {
<a name="l00725"></a>00725     printErrors_ = <span class="keyword">false</span>;
<a name="l00726"></a>00726   } <span class="keywordflow">else</span> {
<a name="l00727"></a>00727     printErrors_ = <span class="keyword">true</span>;
<a name="l00728"></a>00728     lastTimeSecs_ = nowTimeSecs_;
<a name="l00729"></a>00729   }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731   <span class="keywordflow">if</span> (printNextError_) {
<a name="l00732"></a>00732     printErrors_ = <span class="keyword">true</span>;
<a name="l00733"></a>00733   }
<a name="l00734"></a>00734 
<a name="l00735"></a>00735   <span class="comment">//Set any controller specific parameters. </span>
<a name="l00736"></a>00736   <span class="comment">//Some of these may be used by the axis poll to set axis bits.</span>
<a name="l00737"></a>00737 
<a name="l00738"></a>00738   <span class="comment">//Transfer limit and home status and pack into uint32_t.</span>
<a name="l00739"></a>00739   int32_t tlim = 0;
<a name="l00740"></a>00740   int32_t tlim_bits = 0;
<a name="l00741"></a>00741   int32_t tlim_offset = 0;
<a name="l00742"></a>00742   getIntegerParam(P6K_C_TLIM_Enable_, &amp;tlim);
<a name="l00743"></a>00743   setIntegerParam(P6K_C_TLIM_Bits_, 0);
<a name="l00744"></a>00744   <span class="keywordflow">if</span> (tlim == 1) {
<a name="l00745"></a>00745     epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%s&quot;</span>, P6K_CMD_TLIM);
<a name="l00746"></a>00746     stat = (lowLevelWriteRead(command, response) == asynSuccess) &amp;&amp; stat;
<a name="l00747"></a>00747     <span class="keywordflow">if</span> (stat) {
<a name="l00748"></a>00748       nvals = sscanf(response, P6K_CMD_TLIM<span class="stringliteral">&quot;%s&quot;</span>, stringVal);
<a name="l00749"></a>00749       <span class="keywordflow">for</span> (uint32_t axis=0; axis&lt;P6K_MAXAXES_; ++axis) {
<a name="l00750"></a>00750         <span class="keywordflow">for</span> (uint32_t bit=0; bit&lt;P6K_TLIM_SIZE_; ++bit) {
<a name="l00751"></a>00751           tlim_offset = bit + (P6K_TLIM_SIZE_ * axis);
<a name="l00752"></a>00752           <span class="keywordflow">if</span> (tlim_offset &lt; P6K_MAXBUF_) { 
<a name="l00753"></a>00753             tlim_bits |= ((stringVal[tlim_offset] == P6K_ON_) &lt;&lt; tlim_offset);
<a name="l00754"></a>00754           }
<a name="l00755"></a>00755         }
<a name="l00756"></a>00756       }
<a name="l00757"></a>00757       stat = (setIntegerParam(P6K_C_TLIM_Bits_, tlim_bits) == asynSuccess) &amp;&amp; stat;
<a name="l00758"></a>00758     }
<a name="l00759"></a>00759     memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00760"></a>00760     memset(stringVal, 0, <span class="keyword">sizeof</span>(stringVal));
<a name="l00761"></a>00761   }
<a name="l00762"></a>00762   
<a name="l00763"></a>00763   <span class="comment">//Transfer system status</span>
<a name="l00764"></a>00764   epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%s&quot;</span>, P6K_CMD_TSS);
<a name="l00765"></a>00765   stat = (lowLevelWriteRead(command, response) == asynSuccess) &amp;&amp; stat;
<a name="l00766"></a>00766   <span class="keywordflow">if</span> (stat) {
<a name="l00767"></a>00767     nvals = sscanf(response, P6K_CMD_TSS<span class="stringliteral">&quot;%s&quot;</span>, stringVal);
<a name="l00768"></a>00768   }
<a name="l00769"></a>00769   memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00770"></a>00770    
<a name="l00771"></a>00771   <span class="keywordflow">if</span> (stat) {
<a name="l00772"></a>00772     stat = (setIntegerParam(P6K_C_TSS_SystemReady_, (stringVal[P6K_TSS_SYSTEMREADY_] == P6K_ON_)) == asynSuccess) &amp;&amp; stat;
<a name="l00773"></a>00773     stat = (setIntegerParam(P6K_C_TSS_ProgRunning_, (stringVal[P6K_TSS_PROGRUNNING_] == P6K_ON_)) == asynSuccess) &amp;&amp; stat;
<a name="l00774"></a>00774     stat = (setIntegerParam(P6K_C_TSS_Immediate_,   (stringVal[P6K_TSS_IMMEDIATE_]   == P6K_ON_)) == asynSuccess) &amp;&amp; stat;
<a name="l00775"></a>00775     stat = (setIntegerParam(P6K_C_TSS_CmdError_,    (stringVal[P6K_TSS_CMDERROR_]    == P6K_ON_)) == asynSuccess) &amp;&amp; stat;
<a name="l00776"></a>00776     stat = (setIntegerParam(P6K_C_TSS_MemError_,    (stringVal[P6K_TSS_MEMERROR_]    == P6K_ON_)) == asynSuccess) &amp;&amp; stat;
<a name="l00777"></a>00777   }
<a name="l00778"></a>00778   
<a name="l00779"></a>00779   callParamCallbacks();
<a name="l00780"></a>00780 
<a name="l00781"></a>00781   <span class="keywordflow">if</span> (!stat) {
<a name="l00782"></a>00782     <span class="keywordflow">if</span> (printErrors_) {
<a name="l00783"></a>00783       asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00784"></a>00784                 <span class="stringliteral">&quot;%s: ERROR: Problem reading status on controller %s\n&quot;</span>, 
<a name="l00785"></a>00785                 functionName, this-&gt;portName);
<a name="l00786"></a>00786     }
<a name="l00787"></a>00787     setIntegerParam(P6K_C_CommsError_, P6K_ERROR_);
<a name="l00788"></a>00788     setStringParam(P6K_C_Error_, <span class="stringliteral">&quot;Problem reading controller status&quot;</span>);
<a name="l00789"></a>00789     printNextError_ = <span class="keyword">false</span>;
<a name="l00790"></a>00790     <span class="keywordflow">return</span> asynError;
<a name="l00791"></a>00791   } <span class="keywordflow">else</span> {
<a name="l00792"></a>00792     <span class="keywordflow">if</span> (!printErrors_) {
<a name="l00793"></a>00793       asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00794"></a>00794                 <span class="stringliteral">&quot;%s: Problem cleared on controller %s\n&quot;</span>, 
<a name="l00795"></a>00795                 functionName, this-&gt;portName);
<a name="l00796"></a>00796     }
<a name="l00797"></a>00797     setIntegerParam(P6K_C_CommsError_, P6K_OK_);
<a name="l00798"></a>00798     setStringParam(P6K_C_Error_, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00799"></a>00799     printNextError_ = <span class="keyword">true</span>;
<a name="l00800"></a>00800     <span class="keywordflow">return</span> asynSuccess;
<a name="l00801"></a>00801   }
<a name="l00802"></a>00802 }
<a name="l00803"></a>00803 
<a name="l00804"></a>00804 
<a name="l00822"></a><a class="code" href="classp6kController.html#a01dd35adfa9e7382ce2314f301f15fda">00822</a> asynStatus <a class="code" href="classp6kController.html#a01dd35adfa9e7382ce2314f301f15fda">p6kController::upload</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename) 
<a name="l00823"></a>00823 {
<a name="l00824"></a>00824   asynStatus status = asynSuccess;
<a name="l00825"></a>00825   FILE *fptr = NULL;
<a name="l00826"></a>00826   <span class="keywordtype">char</span> line[P6K_MAXBUF_] = {0};
<a name="l00827"></a>00827   <span class="keywordtype">char</span> response[P6K_MAXBUF_] = {0};
<a name="l00828"></a>00828   <span class="keyword">const</span> <span class="keywordtype">char</span> *whitespace = <span class="stringliteral">&quot;# \n\t&quot;</span>;
<a name="l00829"></a>00829   uint32_t count = 0;
<a name="l00830"></a>00830   <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kController::upload&quot;</span>;
<a name="l00831"></a>00831 
<a name="l00832"></a>00832   asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);  
<a name="l00833"></a>00833 
<a name="l00834"></a>00834   printf(<span class="stringliteral">&quot;%s: Uploading file: %s\n&quot;</span>, functionName, filename);  
<a name="l00835"></a>00835 
<a name="l00836"></a>00836   <span class="keywordflow">if</span> (access(filename, R_OK) != 0) {
<a name="l00837"></a>00837     perror(functionName);
<a name="l00838"></a>00838     asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00839"></a>00839               <span class="stringliteral">&quot;%s ERROR: File could not be read.\n&quot;</span>, functionName);
<a name="l00840"></a>00840     setStringParam(P6K_C_Error_, <span class="stringliteral">&quot;ERROR: Upload file could not be read.&quot;</span>);
<a name="l00841"></a>00841     status = asynError;
<a name="l00842"></a>00842   }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844   <span class="keywordflow">if</span> (status == asynSuccess) {
<a name="l00845"></a>00845     <span class="keywordflow">if</span> ((fptr = fopen(filename, <span class="stringliteral">&quot;r&quot;</span>)) == NULL) {
<a name="l00846"></a>00846       perror(functionName);
<a name="l00847"></a>00847       asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00848"></a>00848                 <span class="stringliteral">&quot;%s ERROR: File could not be read.\n&quot;</span>, functionName);
<a name="l00849"></a>00849       status = asynError;
<a name="l00850"></a>00850     }
<a name="l00851"></a>00851 
<a name="l00852"></a>00852     <span class="keywordflow">while</span> (fgets(line, P6K_MAXBUF_-1, fptr)) {
<a name="l00853"></a>00853       <span class="comment">//Remove newline</span>
<a name="l00854"></a>00854       line[strlen(line)-1]=<span class="charliteral">&apos;\0&apos;</span>;
<a name="l00855"></a>00855       <span class="comment">//reject if any whitespace</span>
<a name="l00856"></a>00856       <span class="keywordflow">if</span> (strpbrk(line, whitespace) == NULL) {
<a name="l00857"></a>00857         printf(<span class="stringliteral">&quot;%s: %s\n&quot;</span>, functionName, line);  
<a name="l00858"></a>00858         <span class="keywordflow">if</span> (lowLevelWriteRead(line, response) != asynSuccess) {
<a name="l00859"></a>00859           asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00860"></a>00860                     <span class="stringliteral">&quot;%s: Command %s failed.\n&quot;</span>, functionName, line);
<a name="l00861"></a>00861           status = asynError;
<a name="l00862"></a>00862           <span class="keywordflow">break</span>;
<a name="l00863"></a>00863         }
<a name="l00864"></a>00864         ++count;
<a name="l00865"></a>00865       } <span class="keywordflow">else</span> {
<a name="l00866"></a>00866         asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00867"></a>00867                   <span class="stringliteral">&quot;%s: Skipping %s due to whitespace.\n&quot;</span>, functionName, line);
<a name="l00868"></a>00868         status = asynError;
<a name="l00869"></a>00869         <span class="keywordflow">break</span>;
<a name="l00870"></a>00870       }
<a name="l00871"></a>00871       memset(line, 0, <span class="keyword">sizeof</span>(line));
<a name="l00872"></a>00872     }
<a name="l00873"></a>00873     
<a name="l00874"></a>00874   }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876   <span class="keywordflow">if</span> (fclose(fptr)) {
<a name="l00877"></a>00877     perror(functionName);
<a name="l00878"></a>00878   }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880   <span class="keywordflow">if</span> (count==0) {
<a name="l00881"></a>00881     asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00882"></a>00882               <span class="stringliteral">&quot;%s ERROR: Empty file.\n&quot;</span>, functionName);
<a name="l00883"></a>00883     status = asynError;
<a name="l00884"></a>00884   }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886   <span class="keywordflow">if</span> (status != asynSuccess) {
<a name="l00887"></a>00887     setIntegerParam(P6K_C_Config_, 0);
<a name="l00888"></a>00888     callParamCallbacks();
<a name="l00889"></a>00889   }
<a name="l00890"></a>00890 
<a name="l00891"></a>00891   <span class="keywordflow">return</span> status;
<a name="l00892"></a>00892 }
<a name="l00893"></a>00893 
<a name="l00894"></a>00894 
<a name="l00901"></a><a class="code" href="classp6kController.html#ad8b3998f6cfb1016e86aff07eb318aca">00901</a> asynStatus <a class="code" href="classp6kController.html#ad8b3998f6cfb1016e86aff07eb318aca">p6kController::setDeferredMoves</a>(<span class="keywordtype">bool</span> deferMoves)
<a name="l00902"></a>00902 {
<a name="l00903"></a>00903   asynStatus status = asynSuccess;
<a name="l00904"></a>00904   <span class="keywordtype">bool</span> stat = <span class="keyword">true</span>;
<a name="l00905"></a>00905   <span class="keywordtype">char</span> command[P6K_MAXBUF_] = {0};
<a name="l00906"></a>00906   <span class="keywordtype">char</span> response[P6K_MAXBUF_] = {0};
<a name="l00907"></a>00907   uint32_t move[P6K_MAXAXES_+1] = {0};
<a name="l00908"></a>00908   <a class="code" href="classp6kAxis.html">p6kAxis</a> *pAxis = NULL;
<a name="l00909"></a>00909   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kController::setDeferredMoves&quot;</span>;
<a name="l00910"></a>00910 
<a name="l00911"></a>00911   cout &lt;&lt; functionName &lt;&lt; endl;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913   asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_FLOW, <span class="stringliteral">&quot;%s\n&quot;</span>, functionName);
<a name="l00914"></a>00914 
<a name="l00915"></a>00915   <span class="comment">//If we are not ending deferred moves then return</span>
<a name="l00916"></a>00916   <span class="keywordflow">if</span> (deferMoves || !movesDeferred_) {
<a name="l00917"></a>00917     movesDeferred_ = <span class="keyword">true</span>;
<a name="l00918"></a>00918     <span class="keywordflow">return</span> asynSuccess;
<a name="l00919"></a>00919   }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921   <span class="comment">//Set the distance to move for each axis</span>
<a name="l00922"></a>00922   <span class="keywordflow">for</span> (int32_t axis=0; axis&lt;numAxes_; ++axis) {
<a name="l00923"></a>00923     pAxis = <a class="code" href="classp6kController.html#a0790d66b39dbebbb6265bcabb167e3a5">getAxis</a>(axis);
<a name="l00924"></a>00924     <span class="keywordflow">if</span> (pAxis != NULL) {
<a name="l00925"></a>00925       <span class="keywordflow">if</span> (pAxis-&gt;deferredMove_) {
<a name="l00926"></a>00926         epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;%dD%d&quot;</span>, pAxis-&gt;axisNo_, pAxis-&gt;deferredPosition_);
<a name="l00927"></a>00927         stat = (lowLevelWriteRead(command, response) == asynSuccess) &amp;&amp; stat;
<a name="l00928"></a>00928         <span class="keywordflow">if</span> (static_cast&lt;uint32_t&gt;(axis) &lt;= P6K_MAXAXES_) {
<a name="l00929"></a>00929           move[axis] = 1;
<a name="l00930"></a>00930         }
<a name="l00931"></a>00931         memset(command, 0, <span class="keyword">sizeof</span>(command));
<a name="l00932"></a>00932       }
<a name="l00933"></a>00933     }
<a name="l00934"></a>00934   }
<a name="l00935"></a>00935 
<a name="l00936"></a>00936   <span class="comment">//If any commands failed, don&apos;t execute, cancel deferred move and return</span>
<a name="l00937"></a>00937   <span class="keywordflow">if</span> (!stat) {
<a name="l00938"></a>00938     asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00939"></a>00939               <span class="stringliteral">&quot;%s ERROR Sending Deferred Move Positions.\n&quot;</span>, functionName);
<a name="l00940"></a>00940     status = asynError;
<a name="l00941"></a>00941   } <span class="keywordflow">else</span> {
<a name="l00942"></a>00942   
<a name="l00943"></a>00943     <span class="comment">//Execute the deferred move</span>
<a name="l00944"></a>00944     epicsSnprintf(command, P6K_MAXBUF, <span class="stringliteral">&quot;GO%d%d%d%d%d%d%d%d&quot;</span>, 
<a name="l00945"></a>00945              move[1],move[2],move[3],move[4],move[5],move[6],move[7],move[8]);
<a name="l00946"></a>00946     <span class="keywordflow">if</span> (lowLevelWriteRead(command, response) != asynSuccess) {
<a name="l00947"></a>00947       asynPrint(this-&gt;pasynUserSelf, ASYN_TRACE_ERROR, 
<a name="l00948"></a>00948                 <span class="stringliteral">&quot;%s ERROR Sending Deferred Move Command.\n&quot;</span>, functionName);
<a name="l00949"></a>00949       setStringParam(P6K_C_Error_, <span class="stringliteral">&quot;ERROR: Deferred Move Failed&quot;</span>);
<a name="l00950"></a>00950       status = asynError;
<a name="l00951"></a>00951     } <span class="keywordflow">else</span> {
<a name="l00952"></a>00952       setStringParam(P6K_C_Error_, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00953"></a>00953       status = asynSuccess;
<a name="l00954"></a>00954     }
<a name="l00955"></a>00955     
<a name="l00956"></a>00956   }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958   <span class="comment">//Clear deferred move flag for the axes involved.</span>
<a name="l00959"></a>00959   <span class="keywordflow">for</span> (int32_t axis=0; axis&lt;numAxes_; axis++) {
<a name="l00960"></a>00960     pAxis = <a class="code" href="classp6kController.html#a0790d66b39dbebbb6265bcabb167e3a5">getAxis</a>(axis);
<a name="l00961"></a>00961     <span class="keywordflow">if</span> (pAxis!=NULL) {
<a name="l00962"></a>00962       <span class="keywordflow">if</span> (pAxis-&gt;deferredMove_) {
<a name="l00963"></a>00963         pAxis-&gt;deferredMove_ = 0;
<a name="l00964"></a>00964       }
<a name="l00965"></a>00965     }
<a name="l00966"></a>00966   }
<a name="l00967"></a>00967 
<a name="l00968"></a>00968   movesDeferred_ = <span class="keyword">false</span>;
<a name="l00969"></a>00969      
<a name="l00970"></a>00970   <span class="keywordflow">return</span> status;
<a name="l00971"></a>00971 }
<a name="l00972"></a>00972 
<a name="l00973"></a>00973 
<a name="l00974"></a>00974 
<a name="l00975"></a>00975 
<a name="l00976"></a>00976 
<a name="l00977"></a>00977 <span class="comment">/*************************************************************************************/</span>
<a name="l00980"></a>00980 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l00981"></a>00981 
<a name="l00987"></a>00987 asynStatus p6kCreateController(<span class="keyword">const</span> <span class="keywordtype">char</span> *portName, <span class="keyword">const</span> <span class="keywordtype">char</span> *lowLevelPortName, 
<a name="l00988"></a>00988                                <span class="keywordtype">int</span> lowLevelPortAddress, <span class="keywordtype">int</span> numAxes, 
<a name="l00989"></a>00989                                <span class="keywordtype">int</span> movingPollPeriod, <span class="keywordtype">int</span> idlePollPeriod)
<a name="l00990"></a>00990 {
<a name="l00991"></a>00991 
<a name="l00992"></a>00992     <a class="code" href="classp6kController.html">p6kController</a> *pp6kController
<a name="l00993"></a>00993       = <span class="keyword">new</span> <a class="code" href="classp6kController.html#ac4f52e54e4f8047ac602b2760aaa0792">p6kController</a>(portName, lowLevelPortName, lowLevelPortAddress, 
<a name="l00994"></a>00994                           numAxes, movingPollPeriod/1000., idlePollPeriod/1000.);
<a name="l00995"></a>00995     pp6kController = NULL;
<a name="l00996"></a>00996 
<a name="l00997"></a>00997     <span class="keywordflow">return</span> asynSuccess;
<a name="l00998"></a>00998 }
<a name="l00999"></a>00999 
<a name="l01005"></a>01005 asynStatus p6kCreateAxis(<span class="keyword">const</span> <span class="keywordtype">char</span> *p6kName,   <span class="comment">//specify which controller by port name</span>
<a name="l01006"></a>01006                          <span class="keywordtype">int</span> axis)               <span class="comment">//axis number (start from 1).</span>
<a name="l01007"></a>01007 {
<a name="l01008"></a>01008   <a class="code" href="classp6kController.html">p6kController</a> *pC;
<a name="l01009"></a>01009   <a class="code" href="classp6kAxis.html">p6kAxis</a> *pAxis;
<a name="l01010"></a>01010 
<a name="l01011"></a>01011   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kCreateAxis&quot;</span>;
<a name="l01012"></a>01012 
<a name="l01013"></a>01013   pC = (<a class="code" href="classp6kController.html">p6kController</a>*) findAsynPortDriver(p6kName);
<a name="l01014"></a>01014   <span class="keywordflow">if</span> (!pC) {
<a name="l01015"></a>01015     printf(<span class="stringliteral">&quot;%s::%s: ERROR Port %s Not Found.\n&quot;</span>,
<a name="l01016"></a>01016            driverName, functionName, p6kName);
<a name="l01017"></a>01017     <span class="keywordflow">return</span> asynError;
<a name="l01018"></a>01018   }
<a name="l01019"></a>01019 
<a name="l01020"></a>01020   <span class="keywordflow">if</span> (axis == 0) {
<a name="l01021"></a>01021     printf(<span class="stringliteral">&quot;%s::%s: ERROR Axis Number 0 Not Allowed. &quot;</span>
<a name="l01022"></a>01022            <span class="stringliteral">&quot;This Asyn Address Is Reserved For Controller Specific Parameters.\n&quot;</span>,
<a name="l01023"></a>01023            driverName, functionName);
<a name="l01024"></a>01024     <span class="keywordflow">return</span> asynError;
<a name="l01025"></a>01025   }
<a name="l01026"></a>01026   
<a name="l01027"></a>01027   pC-&gt;lock();
<a name="l01028"></a>01028   pAxis = <span class="keyword">new</span> <a class="code" href="classp6kAxis.html">p6kAxis</a>(pC, axis);
<a name="l01029"></a>01029   pAxis = NULL;
<a name="l01030"></a>01030   pC-&gt;unlock();
<a name="l01031"></a>01031   <span class="keywordflow">return</span> asynSuccess;
<a name="l01032"></a>01032 }
<a name="l01033"></a>01033 
<a name="l01042"></a>01042 asynStatus p6kCreateAxes(<span class="keyword">const</span> <span class="keywordtype">char</span> *p6kName,        
<a name="l01043"></a>01043                           <span class="keywordtype">int</span> numAxes)                   
<a name="l01044"></a>01044 {
<a name="l01045"></a>01045   <a class="code" href="classp6kController.html">p6kController</a> *pC;
<a name="l01046"></a>01046   <a class="code" href="classp6kAxis.html">p6kAxis</a> *pAxis;
<a name="l01047"></a>01047 
<a name="l01048"></a>01048   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kCreateAxis&quot;</span>;
<a name="l01049"></a>01049 
<a name="l01050"></a>01050   pC = (<a class="code" href="classp6kController.html">p6kController</a>*) findAsynPortDriver(p6kName);
<a name="l01051"></a>01051   <span class="keywordflow">if</span> (!pC) {
<a name="l01052"></a>01052     printf(<span class="stringliteral">&quot;%s:%s: Error port %s not found\n&quot;</span>,
<a name="l01053"></a>01053            driverName, functionName, p6kName);
<a name="l01054"></a>01054     <span class="keywordflow">return</span> asynError;
<a name="l01055"></a>01055   }
<a name="l01056"></a>01056   
<a name="l01057"></a>01057   pC-&gt;lock();
<a name="l01058"></a>01058   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> axis=1; axis&lt;=numAxes; axis++) {
<a name="l01059"></a>01059     pAxis = <span class="keyword">new</span> <a class="code" href="classp6kAxis.html">p6kAxis</a>(pC, axis);
<a name="l01060"></a>01060     pAxis = NULL;
<a name="l01061"></a>01061   }
<a name="l01062"></a>01062   pC-&gt;unlock();
<a name="l01063"></a>01063   <span class="keywordflow">return</span> asynSuccess;
<a name="l01064"></a>01064 }
<a name="l01065"></a>01065 
<a name="l01071"></a>01071 asynStatus p6kUpload(<span class="keyword">const</span> <span class="keywordtype">char</span> *p6kName, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename)
<a name="l01072"></a>01072 {
<a name="l01073"></a>01073   asynStatus status = asynError; 
<a name="l01074"></a>01074   <a class="code" href="classp6kController.html">p6kController</a> *pC;
<a name="l01075"></a>01075   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *functionName = <span class="stringliteral">&quot;p6kUpload&quot;</span>;
<a name="l01076"></a>01076   pC = (<a class="code" href="classp6kController.html">p6kController</a>*) findAsynPortDriver(p6kName);
<a name="l01077"></a>01077   <span class="keywordflow">if</span> (!pC) {
<a name="l01078"></a>01078     printf(<span class="stringliteral">&quot;%s:%s: Error port %s not found\n&quot;</span>,
<a name="l01079"></a>01079            driverName, functionName, p6kName);
<a name="l01080"></a>01080     <span class="keywordflow">return</span> status;
<a name="l01081"></a>01081   }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083   pC-&gt;lock();
<a name="l01084"></a>01084   status = pC-&gt;<a class="code" href="classp6kController.html#a01dd35adfa9e7382ce2314f301f15fda">upload</a>(filename);
<a name="l01085"></a>01085   pC-&gt;unlock();
<a name="l01086"></a>01086   
<a name="l01087"></a>01087   <span class="keywordflow">return</span> status;
<a name="l01088"></a>01088 }
<a name="l01089"></a>01089 
<a name="l01090"></a>01090 
<a name="l01091"></a>01091 
<a name="l01092"></a>01092 <span class="comment">/* Code for iocsh registration */</span>
<a name="l01093"></a>01093 
<a name="l01094"></a>01094 <span class="comment">/* p6kCreateController */</span>
<a name="l01095"></a>01095 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg p6kCreateControllerArg0 = {<span class="stringliteral">&quot;Controller port name&quot;</span>, iocshArgString};
<a name="l01096"></a>01096 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg p6kCreateControllerArg1 = {<span class="stringliteral">&quot;Low level port name&quot;</span>, iocshArgString};
<a name="l01097"></a>01097 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg p6kCreateControllerArg2 = {<span class="stringliteral">&quot;Low level port address&quot;</span>, iocshArgInt};
<a name="l01098"></a>01098 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg p6kCreateControllerArg3 = {<span class="stringliteral">&quot;Number of axes&quot;</span>, iocshArgInt};
<a name="l01099"></a>01099 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg p6kCreateControllerArg4 = {<span class="stringliteral">&quot;Moving poll rate (ms)&quot;</span>, iocshArgInt};
<a name="l01100"></a>01100 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg p6kCreateControllerArg5 = {<span class="stringliteral">&quot;Idle poll rate (ms)&quot;</span>, iocshArgInt};
<a name="l01101"></a>01101 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg * <span class="keyword">const</span> p6kCreateControllerArgs[] = {&amp;p6kCreateControllerArg0,
<a name="l01102"></a>01102                                                             &amp;p6kCreateControllerArg1,
<a name="l01103"></a>01103                                                             &amp;p6kCreateControllerArg2,
<a name="l01104"></a>01104                                                             &amp;p6kCreateControllerArg3,
<a name="l01105"></a>01105                                                             &amp;p6kCreateControllerArg4,
<a name="l01106"></a>01106                                                             &amp;p6kCreateControllerArg5};
<a name="l01107"></a>01107 <span class="keyword">static</span> <span class="keyword">const</span> iocshFuncDef configp6kCreateController = {<span class="stringliteral">&quot;p6kCreateController&quot;</span>, 6, p6kCreateControllerArgs};
<a name="l01108"></a>01108 <span class="keyword">static</span> <span class="keywordtype">void</span> configp6kCreateControllerCallFunc(<span class="keyword">const</span> iocshArgBuf *args)
<a name="l01109"></a>01109 {
<a name="l01110"></a>01110   p6kCreateController(args[0].sval, args[1].sval, args[2].ival, args[3].ival, args[4].ival, args[5].ival);
<a name="l01111"></a>01111 }
<a name="l01112"></a>01112 
<a name="l01113"></a>01113 
<a name="l01114"></a>01114 <span class="comment">/* p6kCreateAxis */</span>
<a name="l01115"></a>01115 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg p6kCreateAxisArg0 = {<span class="stringliteral">&quot;Controller port name&quot;</span>, iocshArgString};
<a name="l01116"></a>01116 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg p6kCreateAxisArg1 = {<span class="stringliteral">&quot;Axis number&quot;</span>, iocshArgInt};
<a name="l01117"></a>01117 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg * <span class="keyword">const</span> p6kCreateAxisArgs[] = {&amp;p6kCreateAxisArg0,
<a name="l01118"></a>01118                                                      &amp;p6kCreateAxisArg1};
<a name="l01119"></a>01119 <span class="keyword">static</span> <span class="keyword">const</span> iocshFuncDef configp6kAxis = {<span class="stringliteral">&quot;p6kCreateAxis&quot;</span>, 2, p6kCreateAxisArgs};
<a name="l01120"></a>01120 
<a name="l01121"></a>01121 <span class="keyword">static</span> <span class="keywordtype">void</span> configp6kAxisCallFunc(<span class="keyword">const</span> iocshArgBuf *args)
<a name="l01122"></a>01122 {
<a name="l01123"></a>01123   p6kCreateAxis(args[0].sval, args[1].ival);
<a name="l01124"></a>01124 }
<a name="l01125"></a>01125 
<a name="l01126"></a>01126 <span class="comment">/* p6kCreateAxes */</span>
<a name="l01127"></a>01127 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg p6kCreateAxesArg0 = {<span class="stringliteral">&quot;Controller port name&quot;</span>, iocshArgString};
<a name="l01128"></a>01128 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg p6kCreateAxesArg1 = {<span class="stringliteral">&quot;Num Axes&quot;</span>, iocshArgInt};
<a name="l01129"></a>01129 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg * <span class="keyword">const</span> p6kCreateAxesArgs[] = {&amp;p6kCreateAxesArg0,
<a name="l01130"></a>01130                                                      &amp;p6kCreateAxesArg1};
<a name="l01131"></a>01131 <span class="keyword">static</span> <span class="keyword">const</span> iocshFuncDef configp6kAxes = {<span class="stringliteral">&quot;p6kCreateAxes&quot;</span>, 2, p6kCreateAxesArgs};
<a name="l01132"></a>01132 
<a name="l01133"></a>01133 <span class="keyword">static</span> <span class="keywordtype">void</span> configp6kAxesCallFunc(<span class="keyword">const</span> iocshArgBuf *args)
<a name="l01134"></a>01134 {
<a name="l01135"></a>01135   p6kCreateAxes(args[0].sval, args[1].ival);
<a name="l01136"></a>01136 }
<a name="l01137"></a>01137 
<a name="l01138"></a>01138 <span class="comment">/* p6kUpload */</span>
<a name="l01139"></a>01139 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg p6kUploadArg0 = {<span class="stringliteral">&quot;Controller port name&quot;</span>, iocshArgString};
<a name="l01140"></a>01140 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg p6kUploadArg1 = {<span class="stringliteral">&quot;Filename&quot;</span>, iocshArgString};
<a name="l01141"></a>01141 <span class="keyword">static</span> <span class="keyword">const</span> iocshArg * <span class="keyword">const</span> p6kUploadArgs[] = {&amp;p6kUploadArg0,
<a name="l01142"></a>01142                                                  &amp;p6kUploadArg1};
<a name="l01143"></a>01143 <span class="keyword">static</span> <span class="keyword">const</span> iocshFuncDef configp6kUpload = {<span class="stringliteral">&quot;p6kUpload&quot;</span>, 2, p6kUploadArgs};
<a name="l01144"></a>01144 <span class="keyword">static</span> <span class="keywordtype">void</span> configp6kUploadCallFunc(<span class="keyword">const</span> iocshArgBuf *args)
<a name="l01145"></a>01145 {
<a name="l01146"></a>01146   p6kUpload(args[0].sval, args[1].sval);
<a name="l01147"></a>01147 }
<a name="l01148"></a>01148 
<a name="l01149"></a>01149 
<a name="l01150"></a>01150 <span class="keyword">static</span> <span class="keywordtype">void</span> p6kControllerRegister(<span class="keywordtype">void</span>)
<a name="l01151"></a>01151 {
<a name="l01152"></a>01152   iocshRegister(&amp;configp6kCreateController,   configp6kCreateControllerCallFunc);
<a name="l01153"></a>01153   iocshRegister(&amp;configp6kAxis,               configp6kAxisCallFunc);
<a name="l01154"></a>01154   iocshRegister(&amp;configp6kAxes,               configp6kAxesCallFunc);
<a name="l01155"></a>01155   iocshRegister(&amp;configp6kUpload,             configp6kUploadCallFunc);
<a name="l01156"></a>01156 }
<a name="l01157"></a>01157 epicsExportRegistrar(p6kControllerRegister);
<a name="l01158"></a>01158 
<a name="l01159"></a>01159 
<a name="l01160"></a>01160 } <span class="comment">// extern &quot;C&quot;</span>
<a name="l01161"></a>01161 
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 10 Jun 2014 for parker6k by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
